<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>移植 openswitch 到 arm | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="记录适配 HP openswitch 到 arm CPU 的过程。">
<meta name="keywords" content="yocto,bitbake,openswitch,openembedded,oe,ops,download too slowly,下载太慢,sstate,gcc,tune,compile,long,编译太久,适配,移植,porting,adapter,arm,mips,ppc,powerpc">
<meta property="og:type" content="article">
<meta property="og:title" content="移植 openswitch 到 arm">
<meta property="og:url" content="http://yoursite.com/2017/04/21/programmer/yocto/porting_openswitch_to_arm/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="记录适配 HP openswitch 到 arm CPU 的过程。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-04-17T09:58:07.088Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="移植 openswitch 到 arm">
<meta name="twitter:description" content="记录适配 HP openswitch 到 arm CPU 的过程。">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-programmer/yocto/porting_openswitch_to_arm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/21/programmer/yocto/porting_openswitch_to_arm/" class="article-date">
  <time datetime="2017-04-21T03:02:20.000Z" itemprop="datePublished">2017-04-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yocto/">yocto</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      移植 openswitch 到 arm
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>HP ops 目前已过时，现在主导 openswitch 项目的是 DELL 和 SnapRoute，主推 DELL NAS + SnapRoute Flexswitch （称为 opx）。</p>
<p>本文 openswitch 指 HP ops。记录以前移植 openswtich 到 arm CPU 的过程。</p>
<h2 id="1-BSP-适配"><a href="#1-BSP-适配" class="headerlink" title="1. BSP 适配"></a>1. BSP 适配</h2><h3 id="1-1-新增一个新产品"><a href="#1-1-新增一个新产品" class="headerlink" title="1.1. 新增一个新产品"></a>1.1. 新增一个新产品</h3><p>在目录 <code>yocto/openswitch/</code> 下新建 <code>meta-platform-openswitch-[product]</code>，其中 product 对应新增的产品名字，可以从已有的产品目录拷贝。以 xxx 为例子：</p>
<ul>
<li><p>使用 cp 命令，拷贝其他产品目录为 <code>meta-platform-openswitch-xxx</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp meta-platform-openswitch-as6712  meta-platform-openswitch-xxx –r</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除 <code>recipes-kernel</code> 以外的配方目录（以 <code>recipes-*</code> 开头的）</p>
</li>
<li>将目录下所有文件的中 as6712 修改为 xxx，主要有以下几个文件：<ul>
<li><code>conf/machine/as6712.conf</code> 重命名为 <code>conf/machine/xxx.conf</code></li>
<li><code>conf/layer/conf</code></li>
<li><code>README</code></li>
<li><code>rules.make</code></li>
<li><code>recipes-kernel</code> 子目录下的 <code>*.bbappend</code> 中的 <code>PR_append</code></li>
</ul>
</li>
<li>根据 cpu 架构适配 <code>conf/machine/xxx.conf</code> 文件，xxx 的 cpu 是 arm cortexa9 系列，其中 <code>DEFAULTTUNE</code> 定义表示不支持硬件 FPU。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEFAULTTUNE ?= &quot;core2-64&quot;</span><br><span class="line">require conf/machine/include/tune-core2.inc</span><br><span class="line">改成：</span><br><span class="line">DEFAULTTUNE ?= &quot;cortexa9-neon&quot;</span><br><span class="line">require conf/machine/include/tune-cortexa9.inc</span><br></pre></td></tr></table></figure>
<ul>
<li>根据产品支持的内核版本，修订 <code>PREFERRED_VERSION_linux-ops</code> 参数</li>
<li>暂时屏蔽 <code>MACHINE_FEATURES</code> 和 <code>MACHINE_ESSENTIAL_EXTRA_RDEPENDS</code>，根据需要添加          </li>
</ul>
<h3 id="1-2-添加一个新内核版本支持"><a href="#1-2-添加一个新内核版本支持" class="headerlink" title="1.2.  添加一个新内核版本支持"></a>1.2.  添加一个新内核版本支持</h3><ul>
<li>在目录 <code>yocto/openswitch/meta-distro-openswitch/recipes-kernel/linux/</code> 新增 <code>linux-ops_[version].bb</code> 文件，可以从其他版本复制</li>
<li>修订 *.bb 文件<ul>
<li>对应内核版本号，<code>KERNEL_RELEASE = &quot;3.10.18&quot;</code></li>
<li>对应内核源码下载地址，当前为本地地址 <code>SRC_URI = http://192.168.x.x/linux-3.10.18.tar.gz;name=kernel</code></li>
<li>对应源码的 md5sum 值（可以使用 linux md5sum 工具计算），<code>SRC_URI[kernel.md5sum] = &quot;e19cbb242d776223c337e10a31ca9865&quot;</code></li>
<li>对应源码的 sha256sum 值（可以使用 linux sha256sum 工具计算），<code>SRC_URI[kernel.sha256sum]     = &quot;a11abd0ac80c6195aaab16c8be3e97c07c705d0ee135f3c5c092a99c4973b1be&quot;</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>备注：两个 checksum 和下载地址要保证正确，不然编译的时候会出错</p>
</blockquote>
<ul>
<li>由于 openswitch 的 linux-ops 不支持设备树，需要新增文件 <code>linux-dtb.inc</code>，并且修订文件 <code>linux.inc</code>：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOCALVERSION ?= &quot;&quot;</span><br><span class="line">require linux-dtb.inc     #新增</span><br><span class="line">#kernel_conf_variable CMDLINE &quot;\&quot;$&#123;CMDLINE&#125; $&#123;CMDLINE_DEBUG&#125;\&quot;&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>适配 xxx，新增文件：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yocto/openswitch/meta-platform-openswitch-xxx/recipes-kernel/dtc/dtc_git.bbappend</span><br><span class="line">yocto/openswitch/meta-platform-openswitch-xxx/recipes-kernel/linux/linux-ops_3.10.18.bbappend</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>meta-platform-openswitch-xxx/recipes-kernel/linux/linux-ops/</code> 增加内核配置文件以及产品需要的 patch文件</li>
</ul>
<h3 id="1-3-适配完成之后，使用-make-kernel-编译内核模块"><a href="#1-3-适配完成之后，使用-make-kernel-编译内核模块" class="headerlink" title="1.3. 适配完成之后，使用 make kernel 编译内核模块"></a>1.3. 适配完成之后，使用 <code>make kernel</code> 编译内核模块</h3><p>no log。</p>
<h3 id="1-4-调试问题汇总"><a href="#1-4-调试问题汇总" class="headerlink" title="1.4. 调试问题汇总"></a>1.4. 调试问题汇总</h3><ul>
<li>Open-switch 内核默认编译出来的 image 是 zimage，我的设备 uboot 比较老，不支持这种格式；可以通过在 <code>xxx.config</code> 中新增 <code>KERNEL_IMAGETYPE = &quot;uImage&quot;</code> 来指定成 uimage 格式。</li>
<li>在设备树编译的时候，需要指定目录的在内核的绝对地址，不能单单执行个xx.dts: <code>KERNEL_DEVICETREE = &quot;${S}/arch/arm/boot/dts/zzz_yyy.dts&quot;</code></li>
<li>内核编译出来的 image 如果使用 uImage 或者 zImage 的时候，内核需要打开以下配置，并且 cpu 产品目录需要有这个文件 <code>arch/arm/mach-yyy/include/mach/uncompress.h</code>，否则会出现调整内核之后死机：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_BLK_DEV_INITRD=y</span><br><span class="line">CONFIG_INITRAMFS_SOURCE=&quot;&quot;</span><br><span class="line">CONFIG_RD_GZIP=y</span><br><span class="line">CONFIG_DECOMPRESS_GZIP=y</span><br></pre></td></tr></table></figure>
<ul>
<li>如果使用的 uImage 或者 zImage 格式加载，内核的入口函数是 <code>arch/arm/boot/bootp/init.S</code> 中，这个文件主要是跳转到 <code>misc.c</code> 自解压内核 image，然后跳转到真正的内核执行。</li>
<li>如果出现自解压完成，调整到真正内核执行的时候无 log 输出，可以将内核的 <code>early debug</code> 打开，具体配置宏如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_DEBUG_LL=y</span><br><span class="line">CONFIG_DEBUG_LL_UART_NONE=y</span><br><span class="line"># CONFIG_DEBUG_ICEDCC is not set</span><br><span class="line"># CONFIG_DEBUG_SEMIHOSTING is not set</span><br><span class="line">CONFIG_DEBUG_LL_INCLUDE=&quot;mach/debug-macro.S&quot;</span><br><span class="line">CONFIG_UNCOMPRESS_INCLUDE=&quot;mach/uncompress.h&quot;</span><br><span class="line">CONFIG_EARLY_PRINTK=y</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现以下的错误 log，是由于 uboot 未传入正确的设备树或者参数导致：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">10-21-09:30:03.036:Uncompressing Linux... done, booting the kernel.</span><br><span class="line">10-21-09:30:03.036:</span><br><span class="line">10-21-09:30:03.036:Error: unrecognized/unsupported machine ID (r1 = 0x00000bb8).</span><br><span class="line">10-21-09:30:03.036:</span><br><span class="line">10-21-09:30:03.036:Available machine support:</span><br><span class="line">10-21-09:30:03.036:</span><br><span class="line">10-21-09:30:03.051:ID (hex)        NAME</span><br><span class="line">10-21-09:30:03.051:ffffffff        XXX YYY ZZZ</span><br><span class="line">10-21-09:30:03.051:</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>bootm</code> 命令可以带两地址，第一个表示 image 的地址，第二个表示设备树地址，<code>bootm 62000000 - 62400000</code>。</li>
</ul>
<h3 id="1-5-kernel-defconfig"><a href="#1-5-kernel-defconfig" class="headerlink" title="1.5. kernel defconfig"></a>1.5. kernel defconfig</h3><h3 id="1-6-支持-systemd-的-kernel-defconfig"><a href="#1-6-支持-systemd-的-kernel-defconfig" class="headerlink" title="1.6. 支持 systemd 的 kernel defconfig"></a>1.6. 支持 systemd 的 kernel defconfig</h3><p>这里的 defconfig 不全是支持 systemd 所需配置。<br>支持 systemd 所需配置见 <a href="https://github.com/systemd/systemd/blob/master/README" target="_blank" rel="noopener">systemd README</a>，注意不同的 systemd 版本可能对内核的配置要求不一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/yocto/openswitch/meta-platform-openswitch-xxx/recipes-kernel/linux/linux-ops/defconfig b/yocto/openswitch/meta-platform-openswitch-xxx/recipes-kernel/linux/linux-ops/defconfig</span><br><span class="line">index a61c606..06a5f0e 100755</span><br><span class="line">--- a/yocto/openswitch/meta-platform-openswitch-xxx/recipes-kernel/linux/linux-ops/defconfig</span><br><span class="line">+++ b/yocto/openswitch/meta-platform-openswitch-xxx/recipes-kernel/linux/linux-ops/defconfig</span><br><span class="line">@@ -41,7 +41,7 @@ CONFIG_SYSVIPC=y</span><br><span class="line"> CONFIG_SYSVIPC_SYSCTL=y</span><br><span class="line"> CONFIG_POSIX_MQUEUE=y</span><br><span class="line"> CONFIG_POSIX_MQUEUE_SYSCTL=y</span><br><span class="line">-# CONFIG_FHANDLE is not set</span><br><span class="line">+CONFIG_FHANDLE=y</span><br><span class="line"> # CONFIG_AUDIT is not set</span><br><span class="line"> CONFIG_HAVE_GENERIC_HARDIRQS=y</span><br><span class="line"> </span><br><span class="line">@@ -91,7 +91,15 @@ CONFIG_RCU_FANOUT_LEAF=16</span><br><span class="line"> CONFIG_IKCONFIG=y</span><br><span class="line"> CONFIG_IKCONFIG_PROC=y</span><br><span class="line"> CONFIG_LOG_BUF_SHIFT=21</span><br><span class="line">-# CONFIG_CGROUPS is not set</span><br><span class="line">+CONFIG_CGROUPS=y</span><br><span class="line">+# CONFIG_CGROUP_DEBUG is not set</span><br><span class="line">+# CONFIG_CGROUP_FREEZER is not set</span><br><span class="line">+# CONFIG_CGROUP_DEVICE is not set</span><br><span class="line">+# CONFIG_CPUSETS is not set</span><br><span class="line">+# CONFIG_CGROUP_CPUACCT is not set</span><br><span class="line">+# CONFIG_RESOURCE_COUNTERS is not set</span><br><span class="line">+# CONFIG_CGROUP_SCHED is not set</span><br><span class="line">+# CONFIG_BLK_CGROUP is not set</span><br><span class="line"> # CONFIG_CHECKPOINT_RESTORE is not set</span><br><span class="line"> # CONFIG_NAMESPACES is not set</span><br><span class="line"> CONFIG_UIDGID_CONVERTED=y</span><br><span class="line">@@ -99,13 +107,7 @@ CONFIG_UIDGID_CONVERTED=y</span><br><span class="line"> # CONFIG_SCHED_AUTOGROUP is not set</span><br><span class="line"> # CONFIG_SYSFS_DEPRECATED is not set</span><br><span class="line"> # CONFIG_RELAY is not set</span><br><span class="line">-CONFIG_BLK_DEV_INITRD=y</span><br><span class="line">-CONFIG_INITRAMFS_SOURCE=&quot;&quot;</span><br><span class="line">-CONFIG_RD_GZIP=y</span><br><span class="line">-# CONFIG_RD_BZIP2 is not set</span><br><span class="line">-# CONFIG_RD_LZMA is not set</span><br><span class="line">-# CONFIG_RD_XZ is not set</span><br><span class="line">-# CONFIG_RD_LZO is not set</span><br><span class="line">+# CONFIG_BLK_DEV_INITRD is not set</span><br><span class="line"> # CONFIG_CC_OPTIMIZE_FOR_SIZE is not set</span><br><span class="line"> CONFIG_SYSCTL=y</span><br><span class="line"> CONFIG_ANON_INODES=y</span><br><span class="line">@@ -380,12 +382,14 @@ CONFIG_ARM_AMBA=y</span><br><span class="line"> CONFIG_PCI=y</span><br><span class="line"> CONFIG_PCI_DOMAINS=y</span><br><span class="line"> CONFIG_PCI_SYSCALL=y</span><br><span class="line">+# CONFIG_ARCH_SUPPORTS_MSI is not set</span><br><span class="line"> # CONFIG_PCI_DEBUG is not set</span><br><span class="line"> # CONFIG_PCI_REALLOC_ENABLE_AUTO is not set</span><br><span class="line"> # CONFIG_PCI_STUB is not set</span><br><span class="line"> # CONFIG_PCI_IOV is not set</span><br><span class="line"> # CONFIG_PCI_PRI is not set</span><br><span class="line"> # CONFIG_PCI_PASID is not set</span><br><span class="line">+# CONFIG_PCIEPORTBUS is not set</span><br><span class="line"> # CONFIG_PCCARD is not set</span><br><span class="line"> </span><br><span class="line"> #</span><br><span class="line">@@ -452,10 +456,7 @@ CONFIG_ATAGS=y</span><br><span class="line"> # CONFIG_DEPRECATED_PARAM_STRUCT is not set</span><br><span class="line"> CONFIG_ZBOOT_ROM_TEXT=0x0</span><br><span class="line"> CONFIG_ZBOOT_ROM_BSS=0x0</span><br><span class="line">-CONFIG_ARM_APPENDED_DTB=y</span><br><span class="line">-CONFIG_ARM_ATAG_DTB_COMPAT=y</span><br><span class="line">-CONFIG_ARM_ATAG_DTB_COMPAT_CMDLINE_FROM_BOOTLOADER=y</span><br><span class="line">-# CONFIG_ARM_ATAG_DTB_COMPAT_CMDLINE_EXTEND is not set</span><br><span class="line">+# CONFIG_ARM_APPENDED_DTB is not set</span><br><span class="line"> CONFIG_CMDLINE=&quot;console=ttyS0,115200n8 maxcpus=1 mem=240M&quot;</span><br><span class="line"> CONFIG_CMDLINE_FROM_BOOTLOADER=y</span><br><span class="line"> # CONFIG_CMDLINE_EXTEND is not set</span><br><span class="line">@@ -463,7 +464,7 @@ CONFIG_CMDLINE_FROM_BOOTLOADER=y</span><br><span class="line"> # CONFIG_XIP_KERNEL is not set</span><br><span class="line"> # CONFIG_KEXEC is not set</span><br><span class="line"> # CONFIG_CRASH_DUMP is not set</span><br><span class="line">-CONFIG_AUTO_ZRELADDR=y</span><br><span class="line">+# CONFIG_AUTO_ZRELADDR is not set</span><br><span class="line"> </span><br><span class="line"> #</span><br><span class="line"> # CPU Power Management</span><br><span class="line">@@ -478,7 +479,7 @@ CONFIG_AUTO_ZRELADDR=y</span><br><span class="line"> #</span><br><span class="line"> # At least one emulation must be selected</span><br><span class="line"> #</span><br><span class="line">-# CONFIG_VFP is not set</span><br><span class="line">+#CONFIG_VFP=y</span><br><span class="line"> </span><br><span class="line"> #</span><br><span class="line"> # Userspace binary formats</span><br><span class="line">@@ -544,6 +545,7 @@ CONFIG_HAVE_NET_DSA=y</span><br><span class="line"> CONFIG_RPS=y</span><br><span class="line"> CONFIG_RFS_ACCEL=y</span><br><span class="line"> CONFIG_XPS=y</span><br><span class="line">+# CONFIG_NETPRIO_CGROUP is not set</span><br><span class="line"> CONFIG_BQL=y</span><br><span class="line"> # CONFIG_BPF_JIT is not set</span><br><span class="line"> </span><br><span class="line">@@ -571,7 +573,8 @@ CONFIG_HAVE_BPF_JIT=y</span><br><span class="line"> # Generic Driver Options</span><br><span class="line"> #</span><br><span class="line"> CONFIG_UEVENT_HELPER_PATH=&quot;/sbin/mdev&quot;</span><br><span class="line">-# CONFIG_DEVTMPFS is not set</span><br><span class="line">+CONFIG_DEVTMPFS=y</span><br><span class="line">+CONFIG_DEVTMPFS_MOUNT=y</span><br><span class="line"> CONFIG_STANDALONE=y</span><br><span class="line"> CONFIG_PREVENT_FIRMWARE_BUILD=y</span><br><span class="line"> CONFIG_FW_LOADER=y</span><br><span class="line">@@ -1760,8 +1763,15 @@ CONFIG_ARM_GIC=y</span><br><span class="line"> #</span><br><span class="line"> CONFIG_DCACHE_WORD_ACCESS=y</span><br><span class="line"> # CONFIG_EXT2_FS is not set</span><br><span class="line">-# CONFIG_EXT3_FS is not set</span><br><span class="line">+CONFIG_EXT3_FS=y</span><br><span class="line">+CONFIG_EXT3_DEFAULTS_TO_ORDERED=y</span><br><span class="line">+CONFIG_EXT3_FS_XATTR=y</span><br><span class="line">+# CONFIG_EXT3_FS_POSIX_ACL is not set</span><br><span class="line">+# CONFIG_EXT3_FS_SECURITY is not set</span><br><span class="line"> # CONFIG_EXT4_FS is not set</span><br><span class="line">+CONFIG_JBD=y</span><br><span class="line">+# CONFIG_JBD_DEBUG is not set</span><br><span class="line">+CONFIG_FS_MBCACHE=y</span><br><span class="line"> # CONFIG_REISERFS_FS is not set</span><br><span class="line"> # CONFIG_JFS_FS is not set</span><br><span class="line"> # CONFIG_XFS_FS is not set</span><br><span class="line">@@ -1769,6 +1779,7 @@ CONFIG_DCACHE_WORD_ACCESS=y</span><br><span class="line"> # CONFIG_BTRFS_FS is not set</span><br><span class="line"> # CONFIG_NILFS2_FS is not set</span><br><span class="line"> # CONFIG_FS_POSIX_ACL is not set</span><br><span class="line">+CONFIG_EXPORTFS=y</span><br><span class="line"> CONFIG_FILE_LOCKING=y</span><br><span class="line"> CONFIG_FSNOTIFY=y</span><br><span class="line"> CONFIG_DNOTIFY=y</span><br><span class="line">@@ -1932,7 +1943,6 @@ CONFIG_HAVE_DEBUG_KMEMLEAK=y</span><br><span class="line"> # CONFIG_DEBUG_LOCKING_API_SELFTESTS is not set</span><br><span class="line"> # CONFIG_DEBUG_STACK_USAGE is not set</span><br><span class="line"> # CONFIG_DEBUG_KOBJECT is not set</span><br><span class="line">-# CONFIG_DEBUG_HIGHMEM is not set</span><br><span class="line"> # CONFIG_DEBUG_BUGVERBOSE is not set</span><br><span class="line"> # CONFIG_DEBUG_INFO is not set</span><br><span class="line"> # CONFIG_DEBUG_VM is not set</span><br><span class="line">@@ -1983,13 +1993,9 @@ CONFIG_HAVE_ARCH_KGDB=y</span><br><span class="line"> # CONFIG_STRICT_DEVMEM is not set</span><br><span class="line"> # CONFIG_ARM_UNWIND is not set</span><br><span class="line"> CONFIG_DEBUG_USER=y</span><br><span class="line">-CONFIG_DEBUG_LL=y</span><br><span class="line">-CONFIG_DEBUG_LL_UART_NONE=y</span><br><span class="line">-# CONFIG_DEBUG_ICEDCC is not set</span><br><span class="line">-# CONFIG_DEBUG_SEMIHOSTING is not set</span><br><span class="line">+# CONFIG_DEBUG_LL is not set</span><br><span class="line"> CONFIG_DEBUG_LL_INCLUDE=&quot;mach/debug-macro.S&quot;</span><br><span class="line"> CONFIG_UNCOMPRESS_INCLUDE=&quot;mach/uncompress.h&quot;</span><br><span class="line">-CONFIG_EARLY_PRINTK=y</span><br><span class="line"> # CONFIG_OC_ETM is not set</span><br><span class="line"> # CONFIG_PID_IN_CONTEXTIDR is not set</span><br><span class="line"> </span><br><span class="line">@@ -2142,7 +2148,6 @@ CONFIG_LZO_COMPRESS=y</span><br><span class="line"> CONFIG_LZO_DECOMPRESS=y</span><br><span class="line"> # CONFIG_XZ_DEC is not set</span><br><span class="line"> # CONFIG_XZ_DEC_BCJ is not set</span><br><span class="line">-CONFIG_DECOMPRESS_GZIP=y</span><br><span class="line"> CONFIG_HAS_IOMEM=y</span><br><span class="line"> CONFIG_HAS_IOPORT=y</span><br><span class="line"> CONFIG_HAS_DMA=y</span><br></pre></td></tr></table></figure>
<h2 id="2-gcc-tune"><a href="#2-gcc-tune" class="headerlink" title="2. gcc tune"></a>2. gcc tune</h2><h3 id="2-1-rootfs-不可用"><a href="#2-1-rootfs-不可用" class="headerlink" title="2.1.rootfs 不可用"></a>2.1.rootfs 不可用</h3><p>xxx cpu 为 arm cortex-a9 芯片。<code>DEFAULTTUNE</code> 置为 <code>cortexa9</code> 或 <code>cortexa9-neon</code> 时，编译出来的 rootfs 不可用：<br>启机运行时，会出现 <code>undefined instruction</code>，内核 kill init 退出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">init (1): undefined instruction: pc=b6ebcbdc</span><br><span class="line">Code: e1866315 ee021b90 e2402020 e1866235 (f37204a1)</span><br><span class="line">Kernel panic - not syncing: Attempted to kill init! exitcode=0x00000004</span><br><span class="line"> </span><br><span class="line">CPU1: stopping</span><br><span class="line">CPU: 1 PID: 0 Comm: swapper/1 Tainted: G        W    3.10.18 #1</span><br><span class="line">Backtrace:</span><br><span class="line">[&lt;c00117b8&gt;] (dump_backtrace+0x0/0x10c) from [&lt;c00119cc&gt;] (show_stack+0x18/0x1c)</span><br><span class="line">r6:00000000 r5:00000001 r4:c041d9f8 r3:00000000</span><br><span class="line">[&lt;c00119b4&gt;] (show_stack+0x0/0x1c) from [&lt;c02e2034&gt;] (dump_stack+0x24/0x28)</span><br><span class="line">[&lt;c02e2010&gt;] (dump_stack+0x0/0x28) from [&lt;c0013ca4&gt;] (handle_IPI+0x118/0x134)</span><br><span class="line">[&lt;c0013b8c&gt;] (handle_IPI+0x0/0x134) from [&lt;c0008620&gt;] (gic_handle_irq+0x60/0x64)</span><br><span class="line">r6:ef06ff68 r5:c04022f4 r4:fee2010c r3:c000f14c</span><br><span class="line">[&lt;c00085c0&gt;] (gic_handle_irq+0x0/0x64) from [&lt;c000e0c0&gt;] (__irq_svc+0x40/0x50)</span><br><span class="line">Exception stack(0xef06ff68 to 0xef06ffb0)</span><br><span class="line">ff60:                   c18116b0 00000000 00002fdc 00000000 ef06e000 ef06e000</span><br><span class="line">ff80: c0401f28 c0401f70 c02e7b2c ef06e000 ef06e000 ef06ffbc ef06ffc0 ef06ffb0</span><br><span class="line">ffa0: c000f14c c000f150 60000113 ffffffff</span><br><span class="line">r7:ef06ff9c r6:ffffffff r5:60000113 r4:c000f150</span><br><span class="line">[&lt;c000f11c&gt;] (arch_cpu_idle+0x0/0x38) from [&lt;c0055c60&gt;] (cpu_startup_entry+0xec/0x13c)</span><br><span class="line">[&lt;c0055b74&gt;] (cpu_startup_entry+0x0/0x13c) from [&lt;c02debd8&gt;] (secondary_start_kernel+0x128/0x130)</span><br><span class="line">r7:c041da1c</span><br><span class="line">[&lt;c02deab0&gt;] (secondary_start_kernel+0x0/0x130) from [&lt;612de104&gt;] (0x612de104)</span><br><span class="line">r4:9003c06a r3:c02de0ec</span><br></pre></td></tr></table></figure>
<p>这个问题排查了约两个星期，排查的方向：</p>
<ul>
<li>内核是否支持 systemd？<br>根据 systemd 官方说明文档配置内核，启机还是挂在同样的地方；</li>
<li>rootfs 的格式是不是有问题（ubifs 还是 ext3）？<br>把 rootfs 改为 ubifs，启机还是挂在同样的地方；</li>
<li>反汇编<br>通过 <code>objdump</code> vmlinux 或看system map table，都没有对应 PC 值。这个 undefined instruction 的意思应该就是说明没有这个指令，所以不用看了，找也找不着。</li>
</ul>
<p>偶然的机会，与同事的讨论中，他曾经在某个产品上使用 debian 8 （默认采用 systemd） 的 rootfs 跑过。因此通过 ops-build 编译的 kernel + debian 8 rootfs （U盘启动）确认内核没有问题。<br>既然内核没有问题，那就得看 debian jessie arm 版本编译的结果与 ops-build 编译结果的差异，通过 <code>readelf -A systemd</code> 查看 systemd 编译结果的架构相关信息，发现了差异：</p>
<p>不可用的 rootfs：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sunyongfeng@openswitch-OptiPlex-380:~/workshop/rgosm-build/prj_xxx/images/rootfs/lib/systemd$ arm-cortex_a9-linux-gnueabi-readelf -A systemd</span><br><span class="line">Attribute Section: aeabi</span><br><span class="line">File Attributes</span><br><span class="line">  Tag_CPU_name: &quot;7-A&quot;</span><br><span class="line">  Tag_CPU_arch: v7</span><br><span class="line">  Tag_CPU_arch_profile: Application</span><br><span class="line">  Tag_ARM_ISA_use: Yes</span><br><span class="line">  Tag_THUMB_ISA_use: Thumb-2</span><br><span class="line">  Tag_VFP_arch: VFPv3</span><br><span class="line">  Tag_Advanced_SIMD_arch: NEONv1</span><br><span class="line">  Tag_ABI_PCS_wchar_t: 4</span><br><span class="line">  Tag_ABI_FP_rounding: Needed</span><br><span class="line">  Tag_ABI_FP_denormal: Needed</span><br><span class="line">  Tag_ABI_FP_exceptions: Needed</span><br><span class="line">  Tag_ABI_FP_number_model: IEEE 754</span><br><span class="line">  Tag_ABI_align8_needed: Yes</span><br><span class="line">  Tag_ABI_enum_size: int</span><br><span class="line">  Tag_ABI_HardFP_use: SP and DP</span><br><span class="line">  Tag_CPU_unaligned_access: v6</span><br></pre></td></tr></table></figure>
<p>可用的 rootfs：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sunyongfeng@openswitch-OptiPlex-380:~/workshop/rgosm-build/prj_xxx/images/rootfs$ arm-cortex_a9-linux-gnueabi-readelf -A lib/systemd/systemd</span><br><span class="line">Attribute Section: aeabi</span><br><span class="line">File Attributes</span><br><span class="line">  Tag_CPU_name: &quot;4T&quot;</span><br><span class="line">  Tag_CPU_arch: v4T</span><br><span class="line">  Tag_ARM_ISA_use: Yes</span><br><span class="line">  Tag_THUMB_ISA_use: Thumb-1</span><br><span class="line">  Tag_ABI_PCS_wchar_t: 4</span><br><span class="line">  Tag_ABI_FP_rounding: Needed</span><br><span class="line">  Tag_ABI_FP_denormal: Needed</span><br><span class="line">  Tag_ABI_FP_exceptions: Needed</span><br><span class="line">  Tag_ABI_FP_number_model: IEEE 754</span><br><span class="line">  Tag_ABI_align8_needed: Yes</span><br><span class="line">  Tag_ABI_align8_preserved: Yes, except leaf SP</span><br><span class="line">  Tag_ABI_enum_size: int</span><br></pre></td></tr></table></figure>
<p>主要差异在 NEON、VFP 和 HardFP 上。因尝试改 <code>tune-cortexa9.inc</code> 等相关文件调整默认 FPU 等编译选项，但是一直修改失败，因此换了个思路，看 debian porting to arm 用了什么编译选项。详见 <a href="https://wiki.debian.org/ArmEabiPort" target="_blank" rel="noopener">debian 移植到 arm 32 的编译选项</a> ，根据文中的建议 tune gcc。</p>
<h3 id="2-2-tune-gcc"><a href="#2-2-tune-gcc" class="headerlink" title="2.2. tune gcc"></a>2.2. tune gcc</h3><ul>
<li>配置 <code>yocto/openswitch/meta-platform-openswitch-xxx/conf/machine/xxx.conf</code>，改 <code>DEFAULTTUNE</code> 为 <code>armv4t</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEFAULTTUNE ?= &quot;armv4t&quot;</span><br><span class="line">require conf/machine/include/tune-cortexa9.inc</span><br></pre></td></tr></table></figure>
<ul>
<li>配置 <code>yocto/poky/meta/conf/machine/include/arm/arch-arm.inc</code>，改 <code>TARGET_FPU</code> 为 <code>soft</code>，添加选项 <code>-mabi=aapcs-linux</code></li>
<li>配置 <code>yocto/poky/meta/conf/machine/include/arm/feature-arm-neon.inc</code> 和 <code>yocto/poky/meta/conf/machine/include/arm/feature-arm-vfp.inc</code>，把 FPU 相关配置改为 soft。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">sunyongfeng@openswitch-OptiPlex-380:~/workshop/ops-build.rj$ git diff yocto/poky/meta/conf/machine*</span><br><span class="line">diff --git a/yocto/poky/meta/conf/machine/include/arm/arch-arm.inc b/yocto/poky/meta/conf/machine/include/arm/arch-arm.inc</span><br><span class="line">index 90b80c4..b1a04b8 100644</span><br><span class="line">--- a/yocto/poky/meta/conf/machine/include/arm/arch-arm.inc</span><br><span class="line">+++ b/yocto/poky/meta/conf/machine/include/arm/arch-arm.inc</span><br><span class="line">@@ -13,5 +13,6 @@ TUNE_PKGARCH = &quot;$&#123;ARMPKGARCH&#125;$&#123;ARMPKGSFX_THUMB&#125;$&#123;ARMPKGSFX_DSP&#125;$&#123;ARMPKGSFX_EABI&#125;</span><br><span class="line"> </span><br><span class="line">ABIEXTENSION = &quot;eabi&quot;</span><br><span class="line"> </span><br><span class="line">-TARGET_FPU = &quot;$&#123;@d.getVar(&apos;ARMPKGSFX_FPU&apos;, True).strip(&apos;-&apos;) or &apos;soft&apos;&#125;&quot;</span><br><span class="line">+TARGET_FPU = &quot;soft&quot;</span><br><span class="line">+TUNE_CCARGS .= &quot; -mabi=aapcs-linux&quot;</span><br><span class="line"> </span><br><span class="line">diff --git a/yocto/poky/meta/conf/machine/include/arm/feature-arm-neon.inc b/yocto/poky/meta/conf/machine/include/arm/feature-arm-neon.inc</span><br><span class="line">index e8b2b85..25d612e 100644</span><br><span class="line">--- a/yocto/poky/meta/conf/machine/include/arm/feature-arm-neon.inc</span><br><span class="line">+++ b/yocto/poky/meta/conf/machine/include/arm/feature-arm-neon.inc</span><br><span class="line">@@ -1,3 +1,3 @@</span><br><span class="line">TUNEVALID[neon] = &quot;Enable Neon SIMD accelerator unit.&quot;</span><br><span class="line">-TUNE_CCARGS .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;neon&quot;, bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;vfpv4&quot;, &quot; -mfpu=neon-vfpv4&quot;, &quot; -mfpu=neon&quot;, d), &quot;&quot; , d)&#125;&quot;</span><br><span class="line">-ARMPKGSFX_FPU .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;neon&quot;, &quot;-neon&quot;, &quot;&quot;, d)&#125;&quot;</span><br><span class="line">+TUNE_CCARGS .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;neon&quot;, bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;vfpv4&quot;, &quot; -msoft-float&quot;, &quot; -msoft-float&quot;, d), &quot;&quot; , d)&#125;&quot;</span><br><span class="line">+ARMPKGSFX_FPU .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;neon&quot;, &quot;&quot;, &quot;&quot;, d)&#125;&quot;</span><br><span class="line">diff --git a/yocto/poky/meta/conf/machine/include/arm/feature-arm-vfp.inc b/yocto/poky/meta/conf/machine/include/arm/feature-arm-vfp.inc</span><br><span class="line">index 13927ff..73efcb8 100644</span><br><span class="line">--- a/yocto/poky/meta/conf/machine/include/arm/feature-arm-vfp.inc</span><br><span class="line">+++ b/yocto/poky/meta/conf/machine/include/arm/feature-arm-vfp.inc</span><br><span class="line">@@ -2,8 +2,8 @@ TUNEVALID[vfp] = &quot;Enable Vector Floating Point (vfp) unit.&quot;</span><br><span class="line">ARMPKGSFX_FPU .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;vfp&quot;, &quot;-vfp&quot;, &quot;&quot; ,d)&#125;&quot;</span><br><span class="line"> </span><br><span class="line">TUNEVALID[vfpv4] = &quot;Enable Vector Floating Point Version 4 (vfpv4) unit.&quot;</span><br><span class="line">-ARMPKGSFX_FPU .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;vfpv4&quot;, &quot;-vfpv4&quot;, &quot;&quot; ,d)&#125;&quot;</span><br><span class="line">+ARMPKGSFX_FPU .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;vfpv4&quot;, &quot;-vfp&quot;, &quot;&quot; ,d)&#125;&quot;</span><br><span class="line"> </span><br><span class="line">TUNEVALID[callconvention-hard] = &quot;Enable EABI hard float call convention, requires VFP.&quot;</span><br><span class="line">-TUNE_CCARGS .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;vfp&quot;, bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;callconvention-hard&quot;, &quot; -mfloat-abi=hard&quot;, &quot; -mfloat-abi=softfp&quot;, d), &quot;&quot; ,d)&#125;&quot;</span><br><span class="line">-ARMPKGSFX_EABI .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, [ &quot;callconvention-hard&quot;, &quot;vfp&quot; ], &quot;hf&quot;, &quot;&quot;, d)&#125;&quot;</span><br><span class="line">+TUNE_CCARGS .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;vfp&quot;, bb.utils.contains(&quot;TUNE_FEATURES&quot;, &quot;callconvention-hard&quot;, &quot; -mfloat-abi=soft&quot;, &quot; -mfloat-abi=soft&quot;, d), &quot;&quot; ,d)&#125;&quot;</span><br><span class="line">+ARMPKGSFX_EABI .= &quot;$&#123;@bb.utils.contains(&quot;TUNE_FEATURES&quot;, [ &quot;callconvention-hard&quot;, &quot;vfp&quot; ], &quot;&quot;, &quot;&quot;, d)&#125;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-关于-xxx-CPU-是否支持-NEON-和-VFP"><a href="#2-3-关于-xxx-CPU-是否支持-NEON-和-VFP" class="headerlink" title="2.3. 关于 xxx CPU 是否支持 NEON 和 VFP"></a>2.3. 关于 xxx CPU 是否支持 NEON 和 VFP</h3><p>xxx CPU 的芯片手册上有明确写支持 NEON 和 VFP，但是不清楚如何使能 NEON，是否要在上电和通过特定配置使能？<br>通过 <code>cat /proc/cpuinfo</code> 可以看出芯片不支持 NEON 和 VFP，但是 /proc/cpuinfo 能完全体现 CPU features 吗？<br>PS：内核有明确打开了配置 <code>CONFIG_NEON=y</code> 与 <code>CONFIG_VFP=y</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@ops-xxx:~# cat /proc/cpuinfo</span><br><span class="line">processor       : 0</span><br><span class="line">model name      : ARMv7 Processor rev 0 (v7l)</span><br><span class="line">BogoMIPS        : 1987.37</span><br><span class="line">Features        : swp half thumb fastmult edsp tls</span><br><span class="line">CPU implementer : 0x41</span><br><span class="line">CPU architecture: 7</span><br><span class="line">CPU variant     : 0x3</span><br><span class="line">CPU part        : 0xc09</span><br><span class="line">CPU revision    : 0</span><br><span class="line"> </span><br><span class="line">processor       : 1</span><br><span class="line">model name      : ARMv7 Processor rev 0 (v7l)</span><br><span class="line">BogoMIPS        : 1993.93</span><br><span class="line">Features        : swp half thumb fastmult edsp tls</span><br><span class="line">CPU implementer : 0x41</span><br><span class="line">CPU architecture: 7</span><br><span class="line">CPU variant     : 0x3</span><br><span class="line">CPU part        : 0xc09</span><br><span class="line">CPU revision    : 0</span><br><span class="line"> </span><br><span class="line">Hardware        : yyy CPU</span><br><span class="line">Revision        : 0000</span><br><span class="line">Serial          : 0000000000000000</span><br></pre></td></tr></table></figure>
<p>通过查阅资料发现 NEON 应该是在系统运行时使能的：</p>
<blockquote>
<p>内核在遇到第一个NEON指令时会产生一个Undefined Instruction的异常，这会让内核自动重启NEON协处理器，内核还可以在上下文切换时关闭NEON来省电。<br>BY <a href="http://houh-1984.blog.163.com/blog/static/31127834201382694010808/" target="_blank" rel="noopener">《ARM平台NEON指令的编译和优化》</a></p>
</blockquote>
<p>以及：</p>
<blockquote>
<p>arm 论坛 “<a href="https://community.arm.com/thread/8409" target="_blank" rel="noopener">How to enable Neon in cortex A8?</a>“<br>Yes you can’t enable it directly from user mode you have to have the privilege though the startup code for the process or an interrupt when such an instruction is first used should do that normally. For the actual instructions needed have you seen: <a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0472k/chr1359124222192.html" target="_blank" rel="noopener">ARM Compiler armcc User Guide : 5.5 Enabling NEON and FPU for bare-metal</a></p>
</blockquote>
<p>直接在 uboot 中修订？<a href="http://lists.denx.de/pipermail/u-boot/2015-January/201269.html" target="_blank" rel="noopener">http://lists.denx.de/pipermail/u-boot/2015-January/201269.html</a> </p>
<p><strong>TODO</strong> 后续再做验证。<br>FPU 基本只应用于图像处理、音视频处理，与我们无关，因此可以放心不用。</p>
<h2 id="3-编译问题及修订记录"><a href="#3-编译问题及修订记录" class="headerlink" title="3. 编译问题及修订记录"></a>3. 编译问题及修订记录</h2><h3 id="3-1-python-xattr-在-x86-平台上直接使用交叉编译结果"><a href="#3-1-python-xattr-在-x86-平台上直接使用交叉编译结果" class="headerlink" title="3.1. python xattr 在 x86 平台上直接使用交叉编译结果"></a>3.1. python xattr 在 x86 平台上直接使用交叉编译结果</h3><p>问题 log：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">NOTE: Preparing RunQueue</span><br><span class="line">NOTE: Checking sstate mirror object availability (for 545 objects)</span><br><span class="line">NOTE: Executing SetScene Tasks</span><br><span class="line">NOTE: Executing RunQueue Tasks</span><br><span class="line">ERROR: Function failed: do_compile (log file is located at /home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/temp/log.do_compile.14582)</span><br><span class="line">ERROR: Logfile of failure stored in: /home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/temp/log.do_compile.14582</span><br><span class="line">Log data follows:</span><br><span class="line">| DEBUG: Executing shell function do_compile</span><br><span class="line">| running build</span><br><span class="line">| Traceback (most recent call last):</span><br><span class="line">|   File &quot;setup.py&quot;, line 67, in &lt;module&gt;</span><br><span class="line">|     cmdclass=&#123;&apos;build&apos;: cffi_build&#125;,</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/distutils/core.py&quot;, line 151, in setup</span><br><span class="line">|     dist.run_commands()</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/distutils/dist.py&quot;, line 953, in run_commands</span><br><span class="line">|     self.run_command(cmd)</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/distutils/dist.py&quot;, line 971, in run_command</span><br><span class="line">|     cmd_obj.ensure_finalized()</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/distutils/cmd.py&quot;, line 109, in ensure_finalized</span><br><span class="line">|     self.finalize_options()</span><br><span class="line">|   File &quot;setup.py&quot;, line 15, in finalize_options</span><br><span class="line">|     from xattr.lib import ffi</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/xattr-0.8.0/xattr/__init__.py&quot;, line 12, in &lt;module&gt;</span><br><span class="line">|     from .lib import (XATTR_NOFOLLOW, XATTR_CREATE, XATTR_REPLACE,</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/xattr-0.8.0/xattr/lib.py&quot;, line 596, in &lt;module&gt;</span><br><span class="line">|     &quot;&quot;&quot;, ext_package=&apos;xattr&apos;)</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/site-packages/cffi/api.py&quot;, line 424, in verify</span><br><span class="line">|     lib = self.verifier.load_library()</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/site-packages/cffi/verifier.py&quot;, line 111, in load_library</span><br><span class="line">|     return self._load_library()</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/site-packages/cffi/verifier.py&quot;, line 222, in _load_library</span><br><span class="line">|     return self._vengine.load_library()</span><br><span class="line">|   File &quot;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/sysroots/x86_64-linux/usr/lib/python2.7/site-packages/cffi/vengine_cpy.py&quot;, line 155, in load_library</span><br><span class="line">|     raise ffiplatform.VerificationError(error)</span><br><span class="line">| cffi.ffiplatform.VerificationError: importing &apos;/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/xattr-0.8.0/xattr/__pycache__/_cffi__xf88a1d89x3f40c4a9.so&apos;: /home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/xattr-0.8.0/xattr/__pycache__/_cffi__xf88a1d89x3f40c4a9.so: wrong ELF class: ELFCLASS32</span><br><span class="line">| ERROR: python setup.py build execution failed.</span><br><span class="line">| WARNING: exit code 1 from a shell command.</span><br><span class="line">| ERROR: Function failed: do_compile (log file is located at /home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/temp/log.do_compile.14582)</span><br><span class="line">ERROR: Task 3879 (/home/sunyongfeng/workshop/ops-build.rj/yocto/openswitch/meta-foss-openswitch/recipes-devtools/python/python-xattr_0.8.0.bb, do_compile) failed with exit code &apos;1&apos;</span><br><span class="line">NOTE: Tasks Summary: Attempted 2351 tasks of which 2295 didn&apos;t need to be rerun and 1 failed.</span><br><span class="line">Waiting for 0 running tasks to finish:</span><br><span class="line"></span><br><span class="line">Summary: 1 task failed:</span><br><span class="line">  /home/sunyongfeng/workshop/ops-build.rj/yocto/openswitch/meta-foss-openswitch/recipes-devtools/python/python-xattr_0.8.0.bb, do_compile</span><br><span class="line">Summary: There was 1 WARNING message shown.</span><br><span class="line">Summary: There was 1 ERROR message shown, returning a non-zero exit code.</span><br><span class="line">tools/Rules.make:216: recipe for target &apos;_fs&apos; failed</span><br><span class="line">make: *** [_fs] Error 1</span><br><span class="line">sunyongfeng@openswitch-OptiPlex-380:~/workshop/ops-build.rj$</span><br></pre></td></tr></table></figure>
<p>原因：见 <a href="https://github.com/pyca/cryptography/issues/1325" target="_blank" rel="noopener">github issue</a></p>
<blockquote>
<p>I don’t think it’s a cffi issue. I tried to cross compile for a 32 bit system from a 64 bit system. cffi module cffi_backend.so compiled OK for the target (that is 32 bit). <strong>The problem is that when cryptography tries to pre-cross compile (for 32 bit) cffi modules (_Cryptography_cffi*.so), it uses (host) 64 bit compiler flags and tries to load the 32 bit cross compiled _cffi_backend.so.</strong> This is why you get “wrong ELF class: ELFCLASS32”.</p>
<p>There needs to be some way to configure the C compiler flags from within the cryptography package while cross compiling the cffi modules. You can see how cffi module itself is allowing that in its setup.py file. Another python package I was able to configure the target c flags is python readline.</p>
<p>I got around this problem (dirty hack) by skipping the cffi modules pre-cross compilation process (Cryptography_cffi*.so) and copying (during the build time) those modules I compiled on the target system.</p>
</blockquote>
<p>这种交叉编译时在 build 系统上直接使用编译给 host 的结果，很是蛋疼。</p>
<p>解决：</p>
<blockquote>
<p>Well I could get it working myself by following midicase comment on vincentbernat/snimpy.</p>
<ol>
<li>build and install host cffi</li>
<li>build and install target packages that depend in cffi</li>
<li>build and install target cffi<br>I’ve created a detailed install instructions <a href="https://github.com/AndreMiras/km/wiki/CFFI-Cross-Compile" target="_blank" rel="noopener">https://github.com/AndreMiras/km/wiki/CFFI-Cross-Compile</a>.</li>
</ol>
</blockquote>
<p>依葫芦画瓢，也衔把 cffi 编译成 build 主机的结果，后续 ARM 设备上要用的话，再编译一个 ARM 架构的 .so。<br>优雅的做法是打 patch 改 xattr 编译 cffi 的配置文件，先编译成 build 机可用、再编译成 host 机可用的结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sunyongfeng@openswitch-OptiPlex-380:~/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/xattr-0.8.0/xattr/__pycache__$ gcc -o _cffi__xf88a1d89x3f40c4a9.so _cffi__xf88a1d89x3f40c4a9.c -shared -I/usr/include/python2.7/ -fPIC</span><br><span class="line">sunyongfeng@openswitch-OptiPlex-380:~/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/python-xattr/0.8.0-r0/xattr-0.8.0/xattr/__pycache__$ ls</span><br><span class="line">_cffi__x7c9e2f59xb862c7dd.c  _cffi__xf88a1d89x3f40c4a9.c  _cffi__xf88a1d89x3f40c4a9.so  _cffi__xf88a1d89x3f40c4a9.so.arm  xattr</span><br></pre></td></tr></table></figure>
<h3 id="3-2-go-编译失败"><a href="#3-2-go-编译失败" class="headerlink" title="3.2. go 编译失败"></a>3.2. go 编译失败</h3><p>go 编译不过，go 的依赖方是 ops-webui，应该是 web 操作界面相关的东西，目前还用不上直接删了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">| WARNING: exit code 2 from a shell command.</span><br><span class="line">| ERROR: Function failed: do_compile (log file is located at /home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/x86_64-openswitch-linux-gnueabi/go-cross/1.6.3-r0/temp/log.do_compile.31635)</span><br><span class="line">ERROR: Task 3543 (/home/sunyongfeng/workshop/ops-build.rj/yocto/openswitch/meta-foss-openswitch/recipes-devtools/go/go-cross_1.6.3.bb, do_compile) failed with exit code &apos;1&apos;</span><br><span class="line">NOTE: Tasks Summary: Attempted 3606 tasks of which 3599 didn&apos;t need to be rerun and 1 failed.</span><br><span class="line">Waiting for 0 running tasks to finish:</span><br><span class="line"> </span><br><span class="line">Summary: 1 task failed:</span><br></pre></td></tr></table></figure>
<ul>
<li>删除 ops-webui.bb</li>
<li>删除 recipes-go</li>
<li>删除 recipes-nodejs</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deleted:    yocto/openswitch/meta-distro-openswitch/recipes-ops/mgmt/ops-webui.bb</span><br><span class="line">deleted:    yocto/openswitch/meta-foss-openswitch/recipes-go/prometheus/prometheus-promu_git.bb</span><br><span class="line">deleted:    yocto/openswitch/meta-foss-openswitch/recipes-nodejs/nodejs/nodejs.inc</span><br><span class="line">deleted:    yocto/openswitch/meta-foss-openswitch/recipes-nodejs/nodejs/nodejs4.inc</span><br><span class="line">deleted:    yocto/openswitch/meta-foss-openswitch/recipes-nodejs/nodejs/nodejs_4.1.2.bb</span><br></pre></td></tr></table></figure>
<h3 id="3-3-ops-多地方出现-VLOG-format-和指针强转-Warning-导致编译失败"><a href="#3-3-ops-多地方出现-VLOG-format-和指针强转-Warning-导致编译失败" class="headerlink" title="3.3. ops-* 多地方出现 VLOG format 和指针强转 Warning 导致编译失败"></a>3.3. ops-* 多地方出现 VLOG format 和指针强转 Warning 导致编译失败</h3><p>这纯粹是 ops 代码的问题，估计没有 porting 到 32 位机上。<br>出现 warning 的位置实在太多，暂不考虑直接改 .c/.h 源代码。考虑从编译选项入手。</p>
<p>由于带 <code>-Werror</code>，所以 Warning 会被当成 Error 处理。在 <code>local.conf</code> 中配置 <code>-Wno-error</code> 可体现在编译选项中，但是这个编译选项在 <code>-Werror</code> 之前，经确认，要放在之后才能生效。<br>因此需要考虑打 patch 删除源码配置文件中编译选项带的 <code>-Werror</code>。</p>
<p>ops-* 组件使用两种编译工具，CMake 与 autoconf。这里为快速适配，还没有使用打 patch 的方法打补丁。</p>
<h4 id="3-3-1-CMake-类处理"><a href="#3-3-1-CMake-类处理" class="headerlink" title="3.3.1. CMake 类处理"></a>3.3.1. CMake 类处理</h4><p>查找所有 <code>CMakeLists.txt</code> 文件，删除文件中的所有 <code>-Werror</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name &quot;CMakeLists.txt&quot; | xargs sed -i &quot;s/ -Werror//g&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-3-2-autoconf-类处理"><a href="#3-3-2-autoconf-类处理" class="headerlink" title="3.3.2. autoconf 类处理"></a>3.3.2. autoconf 类处理</h4><p>只有 <code>ops-lldpd</code> 组件用的 autoconf 且出现 warning。</p>
<ul>
<li>删除 <code>build/tmp/stamps</code> 目录内 <code>ops-lldpd.do_configure.xxx</code>，这样做才能重新 <code>configure</code>；</li>
<li>修改 <code>build/tmp/work/armv4-openswitch-linux-gnueabi/ops-lldpd/gitAUTOINC+fd74e10ef2-r0/git/ 源码</code>configure.ac<code>文件，将其中的</code>-Werror` 选项删除。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/configure.ac b/configure.ac</span><br><span class="line">index c476286..ea5d5fb 100644</span><br><span class="line">--- a/configure.ac</span><br><span class="line">+++ b/configure.ac</span><br><span class="line">@@ -29,7 +29,7 @@ AC_CONFIG_MACRO_DIR([m4])</span><br><span class="line"> AC_SUBST([CONFIGURE_ARGS], [$ac_configure_args])</span><br><span class="line"> </span><br><span class="line"> # Configure automake</span><br><span class="line">-AM_INIT_AUTOMAKE([foreign -Wall -Werror])</span><br><span class="line">+AM_INIT_AUTOMAKE([foreign -Wall])</span><br><span class="line"> AM_MAINTAINER_MODE</span><br><span class="line"> m4_ifdef([AM_SILENT_RULES], [AM_SILENT_RULES(yes)])</span><br><span class="line"> </span><br><span class="line">@@ -70,7 +70,6 @@ AX_CFLAGS_GCC_OPTION([-fdiagnostics-show-option])</span><br><span class="line"> AX_CFLAGS_GCC_OPTION([-fdiagnostics-color=auto])</span><br><span class="line"> AX_CFLAGS_GCC_OPTION([-pipe])</span><br><span class="line"> AX_CFLAGS_GCC_OPTION([-Wall])</span><br><span class="line">-AX_CFLAGS_GCC_OPTION([-Werror])</span><br><span class="line"> AX_CFLAGS_GCC_OPTION([-W])</span><br><span class="line"> AX_CFLAGS_GCC_OPTION([-Wextra])</span><br><span class="line"> AX_CFLAGS_GCC_OPTION([-Wformat])</span><br></pre></td></tr></table></figure>
<p>这个定义没有的使用地方没有写好，导致好多 ops-lldpd 强转的地方编译不过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">104     /*                                                                                              </span><br><span class="line">105      *  For the initial release, this will just refer to the                                        </span><br><span class="line">106      *  relevant UCD header files.                                                                  </span><br><span class="line">107      *    In due course, the types and structures relevant to the                                   </span><br><span class="line">108      *  Net-SNMP API will be identified, and defined here directly.                                 </span><br><span class="line">109      *                                                                                              </span><br><span class="line">110      *  But for the time being, this header file is primarily a placeholder,                        </span><br><span class="line">111      *  to allow application writers to adopt the new header file names.                            </span><br><span class="line">112      */                                                                                             </span><br><span class="line">113                                                                                                     </span><br><span class="line">114 typedef union &#123;                                                                                     </span><br><span class="line">115    long           *integer;                                                                         </span><br><span class="line">116    u_char         *string;                                                                          </span><br><span class="line">117    oid            *objid;                                                                           </span><br><span class="line">118    u_char         *bitstring;                                                                       </span><br><span class="line">119    struct counter64 *counter64;                                                                     </span><br><span class="line">120 #ifdef NETSNMP_WITH_OPAQUE_SPECIAL_TYPES                                                            </span><br><span class="line">121    float          *floatVal;                                                                        </span><br><span class="line">122    double         *doubleVal;                                                                       </span><br><span class="line">123    /*                                                                                               </span><br><span class="line">124     * t_union *unionVal;                                                                            </span><br><span class="line">125     */                                                                                              </span><br><span class="line">126 #endif                          /* NETSNMP_WITH_OPAQUE_SPECIAL_TYPES */                             </span><br><span class="line">127 &#125; netsnmp_vardata;                                                                                  </span><br><span class="line">128                                                                                                     </span><br><span class="line">129                                                                                                     </span><br><span class="line">130 #define MAX_OID_LEN     128 /* max subid&apos;s in an oid */                                             </span><br><span class="line">131                                                                                                     </span><br><span class="line">132 /** @typedef struct variable_list netsnmp_variable_list                                             </span><br><span class="line">133  * Typedefs the variable_list struct into netsnmp_variable_list */                                  </span><br><span class="line">134 /** @struct variable_list                                                                           </span><br><span class="line">135  * The netsnmp variable list binding structure, it&apos;s typedef&apos;d to                                   </span><br><span class="line">136  * netsnmp_variable_list.                                                                           </span><br><span class="line">137  */                                                                                                 </span><br><span class="line">138 typedef struct variable_list &#123;                                                                      </span><br><span class="line">139    /** NULL for last variable */                                                                    </span><br><span class="line">140    struct variable_list *next_variable;                                                             </span><br><span class="line">141    /** Object identifier of variable */                                                             </span><br><span class="line">142    oid            *name;                                                                            </span><br><span class="line">  ⮀ NORMAL ⮀  net-snmp/types.h</span><br></pre></td></tr></table></figure>
<p>log：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/ops-lldpd/gitAUTOINC+fd74e10ef2-r0/git/src/snmp/lldpPortConfigTable_interface.c: In function &apos;_lldpPortConfigTable_get_column&apos;:</span><br><span class="line">/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/ops-lldpd/gitAUTOINC+fd74e10ef2-r0/git/src/snmp/lldpPortConfigTable_interface.c:323:56: warning: cast increases required alignment of target type [-Wcast-align]</span><br><span class="line">         rc = lldpPortConfigAdminStatus_get(rowreq_ctx, (long *)var-&gt;val.string);</span><br><span class="line">                                                        ^</span><br><span class="line">/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/ops-lldpd/gitAUTOINC+fd74e10ef2-r0/git/src/snmp/lldpPortConfigTable_interface.c:329:51: warning: cast increases required alignment of target type [-Wcast-align]</span><br><span class="line">                                                   (long *)var-&gt;val.string);</span><br><span class="line">                                                   ^</span><br><span class="line">/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/ops-lldpd/gitAUTOINC+fd74e10ef2-r0/git/src/snmp/lldpPortConfigTable_interface.c:336:45: warning: cast increases required alignment of target type [-Wcast-align]</span><br><span class="line">                                             (u_long *)var-&gt;val.string);</span><br><span class="line">                                             ^</span><br><span class="line">/home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/cortexa9-vfp-neon-openswitch-linux-gnueabi/ops-lldpd/gitAUTOINC+fd74e10ef2-r0/git/src/snmp/lldpPortConfigTable_interface.c:340:19: warning: cast increases required alignment of target type [-Wcast-align]</span><br><span class="line">             if (*((u_long *)var-&gt;val.string) &amp; mask)</span><br></pre></td></tr></table></figure>
<h3 id="3-4-openswitch-disk-image-bb-task-do-rootfs-失败"><a href="#3-4-openswitch-disk-image-bb-task-do-rootfs-失败" class="headerlink" title="3.4. openswitch-disk-image.bb task do_rootfs 失败"></a>3.4. openswitch-disk-image.bb task <code>do_rootfs</code> 失败</h3><p>原因：usermod 命令找不到 group ovsdb-client 等 group。log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">| NOTE: Performing usermod with [-R /home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/xxx-openswitch-linux-gnueabi/openswitch-disk-image/1.0-r0/rootfs -g ovsdb-client opsd] and 1 times of retry</span><br><span class="line">| usermod: group &apos;ovsdb-client&apos; does not exist</span><br><span class="line">| Server refused shutdown.  Remaining client fds: 2</span><br><span class="line">| Client pids: 2799 8830</span><br><span class="line">| Server will shut down after all clients exit.</span><br><span class="line">| WARNING: usermod command did not succeed. Retrying...</span><br><span class="line">| ERROR: Tried running usermod command 1 times without success, giving up</span><br><span class="line">| WARNING: exit code 1 from a shell command.</span><br><span class="line">| DEBUG: Python function do_rootfs finished</span><br><span class="line">| ERROR: Function failed: set_user_group (log file is located at /home/sunyongfeng/workshop/ops-build.rj/build/tmp/work/xxx-openswitch-linux-gnueabi/openswitch-disk-image/1.0-r0/temp/log.do_rootfs.2799)</span><br><span class="line">ERROR: Task 7 (/home/sunyongfeng/workshop/ops-build.rj/yocto/openswitch/meta-distro-openswitch/recipes-core/images/openswitch-disk-image.bb, do_rootfs) failed with exit code &apos;1&apos;</span><br><span class="line">NOTE: Tasks Summary: Attempted 4408 tasks of which 4407 didn&apos;t need to be rerun and 1 failed.</span><br><span class="line">No currently running tasks (4405 of 4411)</span><br><span class="line"></span><br><span class="line">Summary: 1 task failed:</span><br><span class="line">  /home/sunyongfeng/workshop/ops-build.rj/yocto/openswitch/meta-distro-openswitch/recipes-core/images/openswitch-disk-image.bb, do_rootfs</span><br><span class="line">Summary: There was 1 WARNING message shown.</span><br><span class="line">Summary: There was 1 ERROR message shown, returning a non-zero exit code.</span><br><span class="line">tools/Rules.make:216: recipe for target &apos;_fs&apos; failed</span><br><span class="line">make: *** [_fs] Error 1</span><br></pre></td></tr></table></figure></p>
<p>看 rootfs 里面，没有看到 group 没有 ops_admin、ovsdb-client 等。而  <code>yocto/openswitch/meta-distro-openswitch/classes/openswitch-image.bbclass</code> 中的 EXTRA_USER_PARAMS 有添加用户到这几个 group 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">inherit core-image extrausers </span><br><span class="line">EXTRA_USERS_PARAMS = &quot;\ </span><br><span class="line">         useradd -N -M -r opsd; \ </span><br><span class="line">         usermod -s /bin/false opsd;\ </span><br><span class="line">         useradd -N -P netop netop; \ </span><br><span class="line">         useradd -N -P admin admin; \ </span><br><span class="line">         useradd -N -P remote_user remote_user; \   </span><br><span class="line">         usermod -g ops_admin admin;\ </span><br><span class="line">         usermod -g ops_netop netop;\</span><br><span class="line">         usermod -g ops_netop remote_user;\ </span><br><span class="line">         usermod -g ovsdb-client opsd;\ </span><br><span class="line">         usermod -G ovsdb-client netop;\ </span><br><span class="line">         usermod -G ovsdb-client remote_user;\</span><br><span class="line">         usermod -s /bin/bash admin;\ </span><br><span class="line">         usermod -s /usr/bin/vtysh netop;\ </span><br><span class="line">         usermod -s /usr/bin/vtysh remote_user;\</span><br><span class="line">         &quot; </span><br><span class="line">IMAGE_FEATURES += &quot;ssh-server-openssh&quot; </span><br><span class="line">IMAGE_FEATURES += &quot;package-management&quot;</span><br><span class="line"></span><br><span class="line">IMAGE_GEN_DEBUGFS = &quot;1&quot; </span><br><span class="line">IMAGE_FSTYPES += &quot;dbg.tar&quot;</span><br></pre></td></tr></table></figure>
<p>而 <code>yocto/openswitch/meta-distro-openswitch/recipes-ops/openvswitch/ops-openvswitch.bb</code> 中有配置添加 group：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GROUPADD_PARAM_$&#123;PN&#125; =&quot;-g 1020 ovsdb-client;ops_netop;ops_admin&quot;</span><br></pre></td></tr></table></figure>
<p>这个配置没在 rootsf 中生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">sunyongfeng@openswitch-OptiPlex-380:~/workshop/ops-build.rj/build/tmp/work/xxx-openswitch-linux-gnueabi/openswitch-disk-image/1.0-r0/rootfs$ cat etc/group </span><br><span class="line">root:x:0:</span><br><span class="line">daemon:x:1:</span><br><span class="line">bin:x:2:</span><br><span class="line">sys:x:3:</span><br><span class="line">adm:x:4:</span><br><span class="line">tty:x:5:</span><br><span class="line">disk:x:6:</span><br><span class="line">lp:x:7:</span><br><span class="line">mail:x:8:</span><br><span class="line">news:x:9:</span><br><span class="line">uucp:x:10:</span><br><span class="line">man:x:12:</span><br><span class="line">proxy:x:13:</span><br><span class="line">kmem:x:15:</span><br><span class="line">input:x:19:</span><br><span class="line">dialout:x:20:</span><br><span class="line">fax:x:21:</span><br><span class="line">voice:x:22:</span><br><span class="line">cdrom:x:24:</span><br><span class="line">floppy:x:25:</span><br><span class="line">tape:x:26:</span><br><span class="line">sudo:x:27:</span><br><span class="line">audio:x:29:</span><br><span class="line">dip:x:30:</span><br><span class="line">www-data:x:33:</span><br><span class="line">backup:x:34:</span><br><span class="line">operator:x:37:</span><br><span class="line">list:x:38:</span><br><span class="line">irc:x:39:</span><br><span class="line">src:x:40:</span><br><span class="line">gnats:x:41:</span><br><span class="line">shadow:x:42:</span><br><span class="line">utmp:x:43:</span><br><span class="line">video:x:44:</span><br><span class="line">sasl:x:45:</span><br><span class="line">plugdev:x:46:</span><br><span class="line">staff:x:50:</span><br><span class="line">games:x:60:</span><br><span class="line">shutdown:x:70:</span><br><span class="line">users:x:100:</span><br><span class="line">nogroup:x:65534:</span><br><span class="line">rpc:x:999:</span><br><span class="line">netdev:x:998:</span><br><span class="line">messagebus:x:997:</span><br><span class="line">sshd:x:996:</span><br><span class="line">lock:x:995:</span><br><span class="line">systemd-journal:x:994:</span><br><span class="line">systemd-journal-gateway:x:993:</span><br><span class="line">systemd-timesync:x:992:</span><br></pre></td></tr></table></figure>
<p>因此，在usermod 使用不存在的 group 前，先执行 groupadd。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/yocto/openswitch/meta-distro-openswitch/classes/openswitch-image.bbclass b/yocto/openswitch/meta-distro-openswitch/classes/openswitch-image.bbclass</span><br><span class="line">index 996503c..5e1e9e8 100644</span><br><span class="line">--- a/yocto/openswitch/meta-distro-openswitch/classes/openswitch-image.bbclass</span><br><span class="line">+++ b/yocto/openswitch/meta-distro-openswitch/classes/openswitch-image.bbclass</span><br><span class="line">@@ -2,6 +2,9 @@ inherit core-image extrausers</span><br><span class="line"> EXTRA_USERS_PARAMS = &quot;\</span><br><span class="line">          useradd -N -M -r opsd; \</span><br><span class="line">          usermod -s /bin/false opsd;\</span><br><span class="line">+         groupadd -g 1020 ovsdb-client; \</span><br><span class="line">+         groupadd ops_netop; \</span><br><span class="line">+         groupadd ops_admin; \</span><br><span class="line">          usermod -g ovsdb-client opsd;\</span><br><span class="line">          useradd -N -P netop netop; \</span><br><span class="line">          useradd -N -P admin admin; \</span><br></pre></td></tr></table></figure>
<h2 id="4-编译太慢？"><a href="#4-编译太慢？" class="headerlink" title="4. 编译太慢？"></a>4. 编译太慢？</h2><h3 id="4-1-下载源码慢的问题"><a href="#4-1-下载源码慢的问题" class="headerlink" title="4.1. 下载源码慢的问题"></a>4.1. 下载源码慢的问题</h3><p>编译的时候，会实时下载要编译的源代码包，由于 GFW 的缘故，代码下载得很慢，导致整个工程编译时间超长。因此可一次下载，多次使用，改 <code>DL_DIR</code>。</p>
<ul>
<li>原始位置，<code>tools/config/local.conf.in</code> 和 <code>tools/config/site.conf.in</code></li>
<li>在 <code>make configure xxx</code> 之后，亦可直接修订 <code>build/conf/local.conf</code></li>
</ul>
<h3 id="4-2-如果使用已编译的结果"><a href="#4-2-如果使用已编译的结果" class="headerlink" title="4.2. 如果使用已编译的结果"></a>4.2. 如果使用已编译的结果</h3><p>利用 yocto sstate 特性。配置 <code>SSTATE_DIR</code></p>
<p>4.1. 和 4.2. 的配置修订如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/tools/config/local.conf.in b/tools/config/local.conf.in</span><br><span class="line">index 80eefbe..eaeb301 100644</span><br><span class="line">--- a/tools/config/local.conf.in</span><br><span class="line">+++ b/tools/config/local.conf.in</span><br><span class="line">@@ -39,7 +39,7 @@ MACHINE = &quot;##PLATFORM##&quot;</span><br><span class="line"> #</span><br><span class="line"> # The default is a downloads directory under TOPDIR which is the build directory.</span><br><span class="line"> #</span><br><span class="line">-#DL_DIR ?= &quot;$&#123;TOPDIR&#125;/downloads&quot;</span><br><span class="line">+DL_DIR ?= &quot;/home/sunyongfeng/backup/downloads&quot;</span><br><span class="line"> </span><br><span class="line"> #</span><br><span class="line"> # Where to place shared-state files</span><br><span class="line">@@ -55,7 +55,7 @@ MACHINE = &quot;##PLATFORM##&quot;</span><br><span class="line"> #</span><br><span class="line"> # The default is a sstate-cache directory under TOPDIR.</span><br><span class="line"> #</span><br><span class="line">-#SSTATE_DIR ?= &quot;$&#123;TOPDIR&#125;/sstate-cache&quot;</span><br><span class="line">+SSTATE_DIR ?= &quot;/home/sunyongfeng/backup/sstate-cache&quot;</span><br><span class="line"> </span><br><span class="line"> #</span><br><span class="line"> # Where to place the build output</span><br><span class="line">@@ -197,10 +197,14 @@ BB_DISKMON_DIRS = &quot;\</span><br><span class="line"> # NOTE: if the mirror uses the same structure as SSTATE_DIR, you need to add PATH</span><br><span class="line"> # at the end as shown in the examples below. This will be substituted with the</span><br><span class="line"> # correct path within the directory structure.</span><br><span class="line">+#SSTATE_MIRRORS ?= &quot;\</span><br><span class="line">+#file://.* http://##DISTRO_SSTATE_ADDRESS##/PATH \</span><br><span class="line">+#&quot;</span><br><span class="line"> SSTATE_MIRRORS ?= &quot;\</span><br><span class="line">-file://.* http://##DISTRO_SSTATE_ADDRESS##/PATH&quot;</span><br><span class="line">+file:///home/sunyongfeng/backup/sstate-cache http://##DISTRO_SSTATE_ADDRESS##/PATH&quot;</span><br><span class="line"> </span><br><span class="line">-SOURCE_MIRROR_URL ?= &quot;http://##DISTRO_ARCHIVE_ADDRESS##/&quot;</span><br><span class="line">+#SOURCE_MIRROR_URL ?= &quot;http://##DISTRO_ARCHIVE_ADDRESS##/&quot;</span><br><span class="line">+SOURCE_MIRROR_URL ?= &quot;file:///home/sunyongfeng/backup/downloads/&quot;</span><br><span class="line"> INHERIT += &quot;own-mirrors&quot; </span><br><span class="line"> BB_GENERATE_MIRROR_TARBALLS = &quot;1&quot;</span><br><span class="line"></span><br><span class="line">diff --git a/tools/config/site.conf.in b/tools/config/site.conf.in</span><br><span class="line">index 9fa46c5..4aa4206 100644</span><br><span class="line">--- a/tools/config/site.conf.in</span><br><span class="line">+++ b/tools/config/site.conf.in</span><br><span class="line">@@ -21,5 +21,5 @@ SCONF_VERSION = &quot;1&quot;</span><br><span class="line"> ##ALL_PROXY##</span><br><span class="line"> </span><br><span class="line"> # Uncomment this to use a shared download directory</span><br><span class="line">-#DL_DIR = &quot;/some/shared/download/directory/&quot;</span><br><span class="line">+DL_DIR = &quot;/home/sunyongfeng/backup/downloads/&quot;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-parse-recipe-实在太慢"><a href="#4-3-parse-recipe-实在太慢" class="headerlink" title="4.3. parse recipe 实在太慢"></a>4.3. parse recipe 实在太慢</h3><p>改 ops-* 的源码路径为 github。但是 ops-tunnel github 上面还没有，需要自己改 DL_DIR 中的 ops-tunnel 包名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DL_DIR 请改成你自己的 DL_DIR</span><br><span class="line"></span><br><span class="line">mv DL_DIR/git2/git.openswitch.net.openswitch.ops-tunnel.done DL_DIR/git2/github.com.open-switch.ops-tunnel.done</span><br><span class="line">mv DL_DIR/git2/git.openswitch.net.openswitch.ops-tunnel DL_DIR/git2/github.com.open-switch.ops-tunnel</span><br></pre></td></tr></table></figure>
<p>patch：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/yocto/openswitch/meta-distro-openswitch/conf/distro/openswitch.conf b/yocto/openswitch/meta-distro-openswitch/conf/distro/openswitch.conf</span><br><span class="line">index dd776f0..b6c18b3 100644</span><br><span class="line">--- a/yocto/openswitch/meta-distro-openswitch/conf/distro/openswitch.conf</span><br><span class="line">+++ b/yocto/openswitch/meta-distro-openswitch/conf/distro/openswitch.conf</span><br><span class="line">@@ -6,8 +6,11 @@ DISTRO_CODENAME = &quot;epazote&quot;</span><br><span class="line"> SDK_VENDOR = &quot;-openswitchsdk&quot;</span><br><span class="line"> SDK_VERSION := &quot;$&#123;@&apos;$&#123;DISTRO_VERSION&#125;&apos;.replace(&apos;snapshot-$&#123;DATE&#125;&apos;,&apos;snapshot&apos;)&#125;&quot;</span><br><span class="line"> </span><br><span class="line">-OPS_REPO_HOSTNAME ?= &quot;git.openswitch.net&quot;</span><br><span class="line">-OPS_REPO_PATH ?= &quot;openswitch&quot;</span><br><span class="line">+#OPS_REPO_HOSTNAME ?= &quot;git.openswitch.net&quot;</span><br><span class="line">+#OPS_REPO_PATH ?= &quot;openswitch&quot;</span><br><span class="line">+#OPS_REPO_BASE_URL ?= &quot;git://$&#123;OPS_REPO_HOSTNAME&#125;/$&#123;OPS_REPO_PATH&#125;&quot;</span><br><span class="line">+OPS_REPO_HOSTNAME ?= &quot;github.com&quot;</span><br><span class="line">+OPS_REPO_PATH ?= &quot;open-switch&quot;</span><br><span class="line"> OPS_REPO_BASE_URL ?= &quot;git://$&#123;OPS_REPO_HOSTNAME&#125;/$&#123;OPS_REPO_PATH&#125;&quot;</span><br><span class="line"> OPS_REPO_PROTOCOL ?= &quot;https&quot;</span><br><span class="line"> OPS_REPO_BRANCH ?= &quot;master&quot;</span><br><span class="line">diff --git a/yocto/openswitch/meta-distro-openswitch/recipes-ops/infra/ops-website.bb b/yocto/openswitch/meta-distro-openswitch/recipes-ops/infra/ops-website.bb</span><br><span class="line">index 79c50f6..caa166d 100644</span><br><span class="line">--- a/yocto/openswitch/meta-distro-openswitch/recipes-ops/infra/ops-website.bb</span><br><span class="line">+++ b/yocto/openswitch/meta-distro-openswitch/recipes-ops/infra/ops-website.bb</span><br><span class="line">@@ -4,7 +4,7 @@ LIC_FILES_CHKSUM = &quot;file://$&#123;COMMON_LICENSE_DIR&#125;/Apache-2.0;md5=89aea4e17d99a7ca</span><br><span class="line"> </span><br><span class="line"> BRANCH ?= &quot;$&#123;OPS_REPO_BRANCH&#125;&quot;</span><br><span class="line"> </span><br><span class="line">-SRC_URI = &quot;git://$&#123;OPS_REPO_HOSTNAME&#125;/infra/website;protocol=$&#123;OPS_REPO_PROTOCOL&#125;;branch=$&#123;BRANCH&#125; \</span><br><span class="line">+SRC_URI = &quot;git://$&#123;OPS_REPO_HOSTNAME&#125;/open-switch/infra_website;protocol=$&#123;OPS_REPO_PROTOCOL&#125;;branch=$&#123;BRANCH&#125; \</span><br><span class="line"> &quot;</span><br><span class="line"> </span><br><span class="line"> SRCREV=&quot;$&#123;AUTOREV&#125;&quot;</span><br><span class="line">diff --git a/yocto/openswitch/meta-distro-openswitch/recipes-ops/switchd/ops-switchd.bb b/yocto/openswitch/meta-distro-openswitch/recipes-ops/switchd/ops-switchd.bb</span><br><span class="line">index 8d622bd..d74cd9e 100644</span><br><span class="line">--- a/yocto/openswitch/meta-distro-openswitch/recipes-ops/switchd/ops-switchd.bb</span><br><span class="line">+++ b/yocto/openswitch/meta-distro-openswitch/recipes-ops/switchd/ops-switchd.bb</span><br><span class="line">@@ -6,7 +6,7 @@ DEPENDS = &quot;ops ops-openvswitch ops-ovsdb ops-utils libyaml jemalloc ops-cli&quot;</span><br><span class="line"> </span><br><span class="line"> BRANCH ?= &quot;$&#123;OPS_REPO_BRANCH&#125;&quot;</span><br><span class="line"> </span><br><span class="line">-SRC_URI = &quot;$&#123;OPS_REPO_BASE_URL&#125;/ops-switchd;protocol=$&#123;OPS_REPO_PROTOCOL&#125;;branch=$&#123;BRANCH&#125; \</span><br><span class="line">+SRC_URI = &quot;$&#123;OPS_REPO_BASE_URL&#125;/ops-switchd.git;protocol=$&#123;OPS_REPO_PROTOCOL&#125;;branch=$&#123;BRANCH&#125; \</span><br><span class="line">    file://switchd_nnn.service \</span><br><span class="line">    file://switchd_sim.service \</span><br><span class="line">    file://switchd_p4sim.service \</span><br><span class="line">@@ -14,7 +14,7 @@ SRC_URI = &quot;$&#123;OPS_REPO_BASE_URL&#125;/ops-switchd;protocol=$&#123;OPS_REPO_PROTOCOL&#125;;branch</span><br><span class="line">    file://switchd_sai.service \</span><br><span class="line"> &quot;</span><br><span class="line"> </span><br><span class="line">-SRCREV = &quot;f17ef096d728b79c77a24cd908fdbcf9b18bcd6c&quot;</span><br><span class="line">+SRCREV = &quot;d345f87cd17ced3b97a73ace23c387de5db62842&quot;</span><br><span class="line"> </span><br><span class="line"> # When using AUTOREV, we need to force the package version to the revision of git</span><br><span class="line"> # in order to avoid stale shared states.</span><br><span class="line">@@ -33,18 +33,18 @@ FILES_$&#123;PN&#125; = &quot;$&#123;sbindir&#125;/ops-switchd $&#123;libdir&#125;/libswitchd_plugins.so.1* $&#123;libdi</span><br><span class="line"> FILES_$&#123;PN&#125; += &quot;/usr/lib/cli/plugins/&quot;</span><br><span class="line"> </span><br><span class="line"> do_install_append() &#123;</span><br><span class="line">-   install -d $&#123;D&#125;$&#123;systemd_unitdir&#125;/system</span><br><span class="line">-   if $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;nnnmmm&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">-      install -m 0644 $&#123;WORKDIR&#125;/switchd_nnn.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">-   elif $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;xpliant&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">-      install -m 0644 $&#123;WORKDIR&#125;/switchd_xpliant.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">-   elif $&#123;@bb.utils.contains(&apos;IMAGE_FEATURES&apos;,&apos;ops-p4&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">+    install -d $&#123;D&#125;$&#123;systemd_unitdir&#125;/system</span><br><span class="line">+#if $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;nnnmmm&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">+#      install -m 0644 $&#123;WORKDIR&#125;/switchd_nnn.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">+#   elif $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;xpliant&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">+#      install -m 0644 $&#123;WORKDIR&#125;/switchd_xpliant.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">+#   elif $&#123;@bb.utils.contains(&apos;IMAGE_FEATURES&apos;,&apos;ops-p4&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">       install -m 0644 $&#123;WORKDIR&#125;/switchd_p4sim.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">-   elif $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;ops-container&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">-      install -m 0644 $&#123;WORKDIR&#125;/switchd_sim.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">-   elif $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;ops-sai&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">-      install -m 0644 $&#123;WORKDIR&#125;/switchd_sai.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">-   fi</span><br><span class="line">+#   elif $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;ops-container&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">+#      install -m 0644 $&#123;WORKDIR&#125;/switchd_sim.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">+#   elif $&#123;@bb.utils.contains(&apos;MACHINE_FEATURES&apos;,&apos;ops-sai&apos;,&apos;true&apos;,&apos;false&apos;,d)&#125;; then</span><br><span class="line">+#      install -m 0644 $&#123;WORKDIR&#125;/switchd_sai.service $&#123;D&#125;$&#123;systemd_unitdir&#125;/system/switchd.service</span><br><span class="line">+#   fi</span><br><span class="line"> </span><br><span class="line">    install -d $&#123;D&#125;/usr/share/opsplugins</span><br><span class="line">    for plugin in $(find $&#123;S&#125;/opsplugins -name &quot;*.py&quot;); do \</span><br></pre></td></tr></table></figure>
<h2 id="5-其他配置"><a href="#5-其他配置" class="headerlink" title="5. 其他配置"></a>5. 其他配置</h2><h3 id="5-1-如何新增-CFLAG、LDFLAG-选项？"><a href="#5-1-如何新增-CFLAG、LDFLAG-选项？" class="headerlink" title="5.1. 如何新增 CFLAG、LDFLAG 选项？"></a>5.1. 如何新增 CFLAG、LDFLAG 选项？</h3><p>在 local.conf 中添加对应 FLAG，以 -Wno-error 为例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BUILD_CFLAGS += &quot; -Wno-error &quot;</span><br><span class="line">BUILD_CPPFLAGS += &quot; -Wno-error &quot;</span><br><span class="line">BUILD_CXXFLAGS += &quot; -Wno-error &quot;</span><br><span class="line">TARGET_CFLAGS += &quot; -Wno-error &quot;</span><br><span class="line">TARGET_CPPFLAGS += &quot; -Wno-error &quot;</span><br><span class="line">TARGET_CXXFLAGS += &quot; -Wno-error &quot;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-使用-pre-built-交叉编译工具链（linaro）"><a href="#5-2-使用-pre-built-交叉编译工具链（linaro）" class="headerlink" title="5.2. 使用 pre-built 交叉编译工具链（linaro）"></a>5.2. 使用 pre-built 交叉编译工具链（linaro）</h3><p>FAIL。</p>
<p>可研究 SDK，将交叉编译链一次编出，后续无需再编译。</p>
<h3 id="5-3-配置-ops-switchd-p4switch-plugin"><a href="#5-3-配置-ops-switchd-p4switch-plugin" class="headerlink" title="5.3. 配置 ops-switchd-p4switch-plugin"></a>5.3. 配置 <code>ops-switchd-p4switch-plugin</code></h3><p>修改 machine 的 conf，<code>yocto/openswitch/meta-platform-openswitch-xxx/conf/machine/xxx.conf</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREFERRED_PROVIDER_virtual/ops-switchd-switch-api-plugin ?= &quot;ops-switchd-p4switch-plugin&quot;</span><br></pre></td></tr></table></figure>
<p>官方 README 的说明应已过时：</p>
<blockquote>
<p>The P4 plugin is activated adding the following line in /build/conf/local.conf EXTRA_IMAGE_FEATURES = “ops-p4” (use += if other image features are defined)<br><a href="https://github.com/open-switch/ops-switchd-p4switch-plugin" target="_blank" rel="noopener">https://github.com/open-switch/ops-switchd-p4switch-plugin</a></p>
</blockquote>
<h2 id="6-运行问题记录与解决"><a href="#6-运行问题记录与解决" class="headerlink" title="6. 运行问题记录与解决"></a>6. 运行问题记录与解决</h2><h3 id="6-1-ops-switchd-p4switch-plugin-没有打包到-rootfs"><a href="#6-1-ops-switchd-p4switch-plugin-没有打包到-rootfs" class="headerlink" title="6.1. ops-switchd-p4switch-plugin 没有打包到 rootfs"></a>6.1. ops-switchd-p4switch-plugin 没有打包到 rootfs</h3><h3 id="6-2-运行时出现-rsyslog、ops-init-servic-等业务起不来"><a href="#6-2-运行时出现-rsyslog、ops-init-servic-等业务起不来" class="headerlink" title="6.2. 运行时出现 rsyslog、ops-init.servic 等业务起不来"></a>6.2. 运行时出现 rsyslog、ops-init.servic 等业务起不来</h3><p>log 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[20161110:184441.388][FAILED] Failed to start openswitch first boot process.</span><br><span class="line">[20161110:184441.388]See &quot;systemctl status ops-first-boot.service&quot; for details.</span><br><span class="line">[20161110:184445.440][FAILED] Failed to start OpenSwitch system initialization script.</span><br><span class="line">[20161110:184445.440]See &quot;systemctl status ops-init.service&quot; for details.</span><br><span class="line">[20161110:184447.615]systemd[1]: Unit ops-powerd.service entered failed state.</span><br><span class="line">[20161110:184447.615]systemd[1]: ops-powerd.service failed.</span><br><span class="line">[20161110:184447.646]systemd[1]: Unit ops-lacpd.service entered failed state.</span><br><span class="line">[20161110:184447.646]systemd[1]: ops-lacpd.service failed.</span><br><span class="line">[20161110:184447.677]systemd[1]: Unit ops-portd.service entered failed state.</span><br><span class="line">[20161110:184447.677]systemd[1]: ops-portd.service failed.</span><br><span class="line">[20161110:184447.708]systemd[1]: Unit ops-tempd.service entered failed state.</span><br><span class="line">[20161110:184447.708]systemd[1]: ops-tempd.service failed.</span><br><span class="line">[20161110:184447.740]systemd[1]: Unit ops-zebra.service entered failed state.</span><br><span class="line">[20161110:184447.740]systemd[1]: ops-zebra.service failed.</span><br><span class="line">[20161110:184447.771]systemd[1]: Unit ops-ledd.service entered failed state.</span><br><span class="line">[20161110:184447.771]systemd[1]: ops-ledd.service failed.</span><br><span class="line">[20161110:184447.802]systemd[1]: Unit aaautils.service entered failed state.</span><br><span class="line">[20161110:184447.802]systemd[1]: aaautils.service failed.</span><br><span class="line">[20161110:184447.833]systemd[1]: Unit ops-stpd.service entered failed state.</span><br><span class="line">[20161110:184447.833]systemd[1]: ops-stpd.service failed.</span><br><span class="line">[20161110:184447.865]systemd[1]: Unit ops-bgpd.service entered failed state.</span><br><span class="line">[20161110:184447.865]systemd[1]: ops-bgpd.service failed.</span><br><span class="line">[20161110:184447.865]systemd[1]: Unit ops-classifierd.service entered failed state.</span><br><span class="line">[20161110:184447.865]systemd[1]: ops-classifierd.service failed.</span><br><span class="line">[20161110:184447.927]systemd[1]: Unit ops-relay.service entered failed state.</span><br><span class="line">[20161110:184447.927]systemd[1]: ops-relay.service failed.</span><br><span class="line">[20161110:184447.958]systemd[1]: Unit ops-intfd.service entered failed state.</span><br><span class="line">[20161110:184447.958]systemd[1]: ops-intfd.service failed.</span><br><span class="line">[20161110:184447.990]systemd[1]: Unit ops-ospfd.service entered failed state.</span><br><span class="line">[20161110:184447.990]systemd[1]: ops-ospfd.service failed.</span><br><span class="line">[20161110:184448.021]systemd[1]: Unit ops-arpmgrd.service entered failed state.</span><br><span class="line">[20161110:184448.021]systemd[1]: ops-arpmgrd.service failed.</span><br><span class="line">[20161110:184448.052]systemd[1]: Unit dhcp_tftp.service entered failed state.</span><br><span class="line">[20161110:184448.052]systemd[1]: dhcp_tftp.service failed.</span><br><span class="line">[20161110:184448.083]systemd[1]: Unit ops-fand.service entered failed state.</span><br><span class="line">[20161110:184448.083]systemd[1]: ops-fand.service failed.</span><br><span class="line">[20161110:184448.115]systemd[1]: Unit ops-sysd.service entered failed state.</span><br><span class="line">[20161110:184448.115]systemd[1]: ops-sysd.service failed.</span><br><span class="line">[20161110:184448.146]systemd[1]: Unit ops-lldpd.service entered failed state.</span><br><span class="line">[20161110:184448.146]systemd[1]: ops-lldpd.service failed.</span><br><span class="line">[20161110:184448.146]systemd[1]: Unit ops-vland.service entered failed state.</span><br><span class="line">[20161110:184448.146]systemd[1]: ops-vland.service failed.</span><br></pre></td></tr></table></figure>
<p>进一步看 log：所有问题都是 <code>open(&quot;/proc/self/ns/net&quot;): No such file or directory</code>，原因是内核配置 namespace 没有开启。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[20161110:184548.411]ops-xxx:~$ systemctl status ops-first-boot.service</span><br><span class="line">[20161110:184548.536]● ops-first-boot.service - openswitch first boot process</span><br><span class="line">[20161110:184548.536]   Loaded: loaded (/lib/systemd/system/ops-first-boot.service; enabled; vendor preset: enabled)</span><br><span class="line">[20161110:184548.536]   Active: failed (Result: exit-code) since Thu 1970-01-01 00:00:08 UTC; 1min 7s ago</span><br><span class="line">[20161110:184548.536]  Process: 100 ExecStart=/usr/sbin/setcap cap_audit_write+eip /usr/bin/vtysh (code=exited, status=1/FAILURE)</span><br><span class="line">[20161110:184548.551] Main PID: 100 (code=exited, status=1/FAILURE)</span><br><span class="line">[20161110:184549.505]ops-xxx:~$ </span><br><span class="line">[20161110:184613.881]ops-xxx:~$ systemd[1]: Unit rsyslog.service entered failed state.</span><br><span class="line">[20161110:184622.878]systemd[1]: Unit rsyslog.service entered failed state.</span><br><span class="line">[20161110:184622.878]systemd[1]: rsyslog.service failed.</span><br><span class="line">[20161110:184624.488]systemctl status rsyslog.service</span><br><span class="line">[20161110:184624.534]● rsyslog.service - System Logging Service</span><br><span class="line">[20161110:184624.534]   Loaded: loaded (/lib/systemd/system/rsyslog.service; enabled; vendor preset: enabled)</span><br><span class="line">[20161110:184624.534]   Active: failed (Result: exit-code) since Thu 1970-01-01 00:01:51 UTC; 41ms ago</span><br><span class="line">[20161110:184624.534]  Process: 3112 ExecStart=/sbin/ip netns exec swns /usr/sbin/rsyslogd -n (code=exited, status=1/FAILURE)</span><br><span class="line">[20161110:184624.550] Main PID: 3112 (code=exited, status=1/FAILURE)</span><br><span class="line">[20161110:184830.707]ops-xxx:~$ systemctl status ops-init.service</span><br><span class="line">[20161110:184830.770]● ops-init.service - OpenSwitch system initialization script</span><br><span class="line">[20161110:184830.770]   Loaded: loaded (/lib/systemd/system/ops-init.service; enabled; vendor preset: enabled)</span><br><span class="line">[20161110:184830.770]   Active: failed (Result: exit-code) since Thu 1970-01-01 00:00:11 UTC; 3min 46s ago</span><br><span class="line">[20161110:184830.770]  Process: 161 ExecStart=/usr/sbin/ops-init (code=exited, status=1/FAILURE)</span><br><span class="line">[20161110:184830.770] Main PID: 161 (code=exited, status=1/FAILURE)</span><br></pre></td></tr></table></figure>
<p>对应的 namespace 内核配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NAMESPACES=y</span><br><span class="line">CONFIG_UTS_NS=y</span><br><span class="line">CONFIG_IPC_NS=y</span><br><span class="line"># CONFIG_USER_NS is not set</span><br><span class="line">CONFIG_PID_NS=y</span><br><span class="line">CONFIG_NET_NS=y</span><br><span class="line">CONFIG_UIDGID_CONVERTED=y</span><br></pre></td></tr></table></figure>
<h3 id="6-3-P4-交换机模拟器启动失败"><a href="#6-3-P4-交换机模拟器启动失败" class="headerlink" title="6.3. P4 交换机模拟器启动失败"></a>6.3. P4 交换机模拟器启动失败</h3><p>log：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[FAILED] Failed to start P4 Switch simulation Daemon.</span><br><span class="line">See &quot;systemctl status simple_switch.service&quot; for details.</span><br></pre></td></tr></table></figure>
<p>原因：内核配置没有开启支持 VNET</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ops-xxx:~$ systemctl status simple_switch.service</span><br><span class="line">● simple_switch.service - P4 Switch simulation Daemon</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/simple_switch.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: failed (Result: exit-code) since Thu 1970-01-01 00:00:13 UTC; 1min 26s ago</span><br><span class="line">  Process: 222 ExecStartPre=/sbin/ip netns exec emulns ip link add veth250 type veth peer name veth251 (code=exited, status=2)</span><br><span class="line">  Process: 214 ExecStartPre=/sbin/ip netns add emulns (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 210 ExecStartPre=/sbin/ip netns del emulns (code=exited, status=1/FAILURE)</span><br><span class="line">  Process: 206 ExecStartPre=/bin/rm -f /var/run/simple_switch.pid (code=exited, status=0/SUCCESS)</span><br><span class="line">ops-xxx:~$ sudo/sbin/ip netns exec emulns ip link add veth250 type veth peer name</span><br><span class="line">RTNETLINK answers: Operation not supported</span><br></pre></td></tr></table></figure>
<h3 id="6-4-CLI-不可用"><a href="#6-4-CLI-不可用" class="headerlink" title="6.4. CLI 不可用"></a>6.4. CLI 不可用</h3><p>log：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ops-xxx:~# vtysh </span><br><span class="line">ops-xxx# show interface </span><br><span class="line">System is not ready. Please retry after few seconds..</span><br></pre></td></tr></table></figure>
<p>ip netns exec emulns ip tuntap add mode tap eth0<br>ip netns exec emulns ifconfig eth0 up</p>
<p>查看 bmv2 runtime command line 命令：<a href="https://github.com/p4lang/behavioral-model/blob/master/tools/runtime_CLI.py" target="_blank" rel="noopener">https://github.com/p4lang/behavioral-model/blob/master/tools/runtime_CLI.py</a><br>runtime cli：ip netns exec emulns /usr/sbin/simple_switch -i 64@veth250 –thrift-port 10001 –nanolog ipc:///tmp/bm-log.ipc /usr/share/ovs_p4_plugin/switch_bmv2.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">set -x</span><br><span class="line"> </span><br><span class="line">for iface in `seq 1 7` ; do</span><br><span class="line">  /sbin/ip netns exec emulns ip tuntap add mode tap eth$iface</span><br><span class="line">  /sbin/ip netns exec emulns /sbin/ip ifconfig eth$iface up</span><br><span class="line">  echo port_add eth$iface `expr $iface - 1` | /sbin/ip netns exec emulns /usr/bin/bm_tools/runtime_CLI.py --json /usr/share/ovs_p4_plugin/switch_bmv2.json --thrift-port 10001</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>可能需要配置的地方：</p>
<ul>
<li><a href="https://github.com/open-switch/ops-build/blob/55c9f56fd3fc7a87cd5c7273374b910998630203/yocto/openswitch/meta-platform-openswitch-genericx86-64/recipes-ops/platform/ops-hw-config.bbappend" target="_blank" rel="noopener">https://github.com/open-switch/ops-build/blob/55c9f56fd3fc7a87cd5c7273374b910998630203/yocto/openswitch/meta-platform-openswitch-genericx86-64/recipes-ops/platform/ops-hw-config.bbappend</a></li>
<li><a href="https://github.com/open-switch/ops-hw-config/tree/master/Generic-x86/X86-64/P4" target="_blank" rel="noopener">https://github.com/open-switch/ops-hw-config/tree/master/Generic-x86/X86-64/P4</a></li>
<li><a href="https://github.com/open-switch/ops-build/blob/55c9f56fd3fc7a87cd5c7273374b910998630203/yocto/openswitch/meta-distro-openswitch/recipes-ops/openvswitch/ops-openvswitch.bb" target="_blank" rel="noopener">https://github.com/open-switch/ops-build/blob/55c9f56fd3fc7a87cd5c7273374b910998630203/yocto/openswitch/meta-distro-openswitch/recipes-ops/openvswitch/ops-openvswitch.bb</a></li>
<li>IMAGE_FEATURES[validitems] += “ops-p4”</li>
</ul>
<h2 id="7-其他问题"><a href="#7-其他问题" class="headerlink" title="7. 其他问题"></a>7. 其他问题</h2><h3 id="x86-64-上的一个-QA-问题"><a href="#x86-64-上的一个-QA-问题" class="headerlink" title="x86_64 上的一个 QA 问题"></a>x86_64 上的一个 QA 问题</h3><p>编译时提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: QA Issue: ops-cli rdepends on libcap, but it isn&apos;t a build dependency? [build-deps]</span><br></pre></td></tr></table></figure>
<p>这个问题可能导致编译  ops-cli 时，configure 不过。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/21/programmer/yocto/porting_openswitch_to_arm/" data-id="cjz95gt6b00n1w5r9j809i9gd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openswitch/">openswitch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yocto/">yocto</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/04/25/linux/xterm/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          xterm / gnome-terminal 无法 tab 补全
        
      </div>
    </a>
  
  
    <a href="/2017/04/20/programmer/python/xmind2excel/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">xmind 转换成 excel</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/administrator/">administrator</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/dokuwiki/">dokuwiki</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/misc/">misc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/networks/">networks</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/newTech/">newTech</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/p4/">p4</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/programmer/">programmer</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools-administrator/">tools, administrator</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/windows/">windows</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/yocto/">yocto</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/思考/">思考</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ARP/">ARP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPU/">CPU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Excel/">Excel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDB/">GDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/L2/">L2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MTU/">MTU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NOS/">NOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SecureCRT/">SecureCRT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/administrator/">administrator</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app/">app</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apt/">apt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm/">arm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arp/">arp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cable/">cable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos/">centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clock/">clock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/compile/">compile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/configure/">configure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/coredump/">coredump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dataplane/">dataplane</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deb/">deb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debian/">debian</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/discourse/">discourse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dokuwiki/">dokuwiki</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dos/">dos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elementary/">elementary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fcitx/">fcitx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gnome-terminal/">gnome-terminal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grub/">grub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/int/">int</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kconfig/">kconfig</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lib/">lib</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libteam/">libteam</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/makefile/">makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mirror/">mirror</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/moinmoin/">moinmoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nat/">nat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/networks/">networks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openswitch/">openswitch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/p4/">p4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/packet/">packet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper/">paper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pip/">pip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ppp/">ppp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pppoe-networks/">pppoe networks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/profiling/">profiling</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programmer/">programmer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/quagga/">quagga</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redhat/">redhat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpc/">rpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpm/">rpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scp/">scp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/serialport/">serialport</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/">server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software/">software</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sshd/">sshd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/">svn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/telnet/">telnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/terminal/">terminal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/time/">time</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tuntap/">tuntap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vagrant/">vagrant</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/veth/">veth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualBox/">virtualBox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vlc/">vlc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vnc/">vnc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wiki/">wiki</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wine/">wine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wireshark/">wireshark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wps/">wps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xterm/">xterm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yocto/">yocto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/串口/">串口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/交叉编译/">交叉编译</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/交换机/">交换机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存管理/">内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/外面的世界/">外面的世界</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/字符流操作/">字符流操作</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/思考/">思考</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件共享/">文件共享</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件系统/">文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/新技术点/">新技术点</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/版本控制/">版本控制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/磁盘管理/">磁盘管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络测试/">网络测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/虚拟机/">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调试/">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/路由协议/">路由协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/进程/">进程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/远程登录/">远程登录</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ARP/" style="font-size: 10px;">ARP</a> <a href="/tags/CPU/" style="font-size: 10px;">CPU</a> <a href="/tags/Excel/" style="font-size: 10px;">Excel</a> <a href="/tags/GDB/" style="font-size: 10px;">GDB</a> <a href="/tags/L2/" style="font-size: 10px;">L2</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/MTU/" style="font-size: 10px;">MTU</a> <a href="/tags/NOS/" style="font-size: 10px;">NOS</a> <a href="/tags/SecureCRT/" style="font-size: 11.82px;">SecureCRT</a> <a href="/tags/administrator/" style="font-size: 17.27px;">administrator</a> <a href="/tags/app/" style="font-size: 10px;">app</a> <a href="/tags/apt/" style="font-size: 10.91px;">apt</a> <a href="/tags/arm/" style="font-size: 10px;">arm</a> <a href="/tags/arp/" style="font-size: 10px;">arp</a> <a href="/tags/c/" style="font-size: 16.36px;">c</a> <a href="/tags/cable/" style="font-size: 10px;">cable</a> <a href="/tags/centos/" style="font-size: 10px;">centos</a> <a href="/tags/clock/" style="font-size: 10px;">clock</a> <a href="/tags/compile/" style="font-size: 10.91px;">compile</a> <a href="/tags/configure/" style="font-size: 10px;">configure</a> <a href="/tags/coredump/" style="font-size: 10px;">coredump</a> <a href="/tags/dataplane/" style="font-size: 10px;">dataplane</a> <a href="/tags/deb/" style="font-size: 13.64px;">deb</a> <a href="/tags/debian/" style="font-size: 10.91px;">debian</a> <a href="/tags/discourse/" style="font-size: 10px;">discourse</a> <a href="/tags/docker/" style="font-size: 10.91px;">docker</a> <a href="/tags/dokuwiki/" style="font-size: 12.73px;">dokuwiki</a> <a href="/tags/dos/" style="font-size: 10px;">dos</a> <a href="/tags/elementary/" style="font-size: 10px;">elementary</a> <a href="/tags/fcitx/" style="font-size: 10px;">fcitx</a> <a href="/tags/gcc/" style="font-size: 10px;">gcc</a> <a href="/tags/git/" style="font-size: 15.45px;">git</a> <a href="/tags/gnome-terminal/" style="font-size: 10px;">gnome-terminal</a> <a href="/tags/grub/" style="font-size: 10px;">grub</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/int/" style="font-size: 10.91px;">int</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/kconfig/" style="font-size: 10px;">kconfig</a> <a href="/tags/kernel/" style="font-size: 11.82px;">kernel</a> <a href="/tags/lib/" style="font-size: 10px;">lib</a> <a href="/tags/libteam/" style="font-size: 10px;">libteam</a> <a href="/tags/linux/" style="font-size: 13.64px;">linux</a> <a href="/tags/makefile/" style="font-size: 10px;">makefile</a> <a href="/tags/mirror/" style="font-size: 10px;">mirror</a> <a href="/tags/misc/" style="font-size: 11.82px;">misc</a> <a href="/tags/moinmoin/" style="font-size: 10px;">moinmoin</a> <a href="/tags/nat/" style="font-size: 10px;">nat</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/networks/" style="font-size: 14.55px;">networks</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/openswitch/" style="font-size: 10.91px;">openswitch</a> <a href="/tags/p4/" style="font-size: 14.55px;">p4</a> <a href="/tags/packet/" style="font-size: 10.91px;">packet</a> <a href="/tags/paper/" style="font-size: 10px;">paper</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/pip/" style="font-size: 10px;">pip</a> <a href="/tags/ppp/" style="font-size: 10px;">ppp</a> <a href="/tags/pppoe-networks/" style="font-size: 10px;">pppoe networks</a> <a href="/tags/profiling/" style="font-size: 10px;">profiling</a> <a href="/tags/programmer/" style="font-size: 10px;">programmer</a> <a href="/tags/python/" style="font-size: 13.64px;">python</a> <a href="/tags/quagga/" style="font-size: 10px;">quagga</a> <a href="/tags/redhat/" style="font-size: 10px;">redhat</a> <a href="/tags/redis/" style="font-size: 10.91px;">redis</a> <a href="/tags/rpc/" style="font-size: 10px;">rpc</a> <a href="/tags/rpm/" style="font-size: 10px;">rpm</a> <a href="/tags/scp/" style="font-size: 10px;">scp</a> <a href="/tags/serialport/" style="font-size: 10.91px;">serialport</a> <a href="/tags/server/" style="font-size: 10px;">server</a> <a href="/tags/software/" style="font-size: 10px;">software</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/sshd/" style="font-size: 10px;">sshd</a> <a href="/tags/svn/" style="font-size: 10.91px;">svn</a> <a href="/tags/telnet/" style="font-size: 10px;">telnet</a> <a href="/tags/terminal/" style="font-size: 10px;">terminal</a> <a href="/tags/time/" style="font-size: 10px;">time</a> <a href="/tags/tuntap/" style="font-size: 10px;">tuntap</a> <a href="/tags/ubuntu/" style="font-size: 19.09px;">ubuntu</a> <a href="/tags/vagrant/" style="font-size: 10px;">vagrant</a> <a href="/tags/veth/" style="font-size: 10px;">veth</a> <a href="/tags/vim/" style="font-size: 11.82px;">vim</a> <a href="/tags/virtualBox/" style="font-size: 10px;">virtualBox</a> <a href="/tags/vlc/" style="font-size: 10px;">vlc</a> <a href="/tags/vnc/" style="font-size: 10px;">vnc</a> <a href="/tags/wiki/" style="font-size: 10px;">wiki</a> <a href="/tags/windows/" style="font-size: 12.73px;">windows</a> <a href="/tags/wine/" style="font-size: 10px;">wine</a> <a href="/tags/wireshark/" style="font-size: 10px;">wireshark</a> <a href="/tags/wps/" style="font-size: 10px;">wps</a> <a href="/tags/xterm/" style="font-size: 10px;">xterm</a> <a href="/tags/yocto/" style="font-size: 10.91px;">yocto</a> <a href="/tags/串口/" style="font-size: 10.91px;">串口</a> <a href="/tags/交叉编译/" style="font-size: 10px;">交叉编译</a> <a href="/tags/交换机/" style="font-size: 10px;">交换机</a> <a href="/tags/内存管理/" style="font-size: 10px;">内存管理</a> <a href="/tags/外面的世界/" style="font-size: 10px;">外面的世界</a> <a href="/tags/字符流操作/" style="font-size: 10.91px;">字符流操作</a> <a href="/tags/思考/" style="font-size: 10.91px;">思考</a> <a href="/tags/数据结构/" style="font-size: 10px;">数据结构</a> <a href="/tags/文件共享/" style="font-size: 10px;">文件共享</a> <a href="/tags/文件系统/" style="font-size: 18.18px;">文件系统</a> <a href="/tags/新技术点/" style="font-size: 10px;">新技术点</a> <a href="/tags/版本控制/" style="font-size: 15.45px;">版本控制</a> <a href="/tags/磁盘管理/" style="font-size: 10px;">磁盘管理</a> <a href="/tags/网络测试/" style="font-size: 12.73px;">网络测试</a> <a href="/tags/虚拟机/" style="font-size: 10px;">虚拟机</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a> <a href="/tags/路由协议/" style="font-size: 10px;">路由协议</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a> <a href="/tags/远程登录/" style="font-size: 12.73px;">远程登录</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/23/misc/screen_too_bright/">屏幕太“亮”看不清灰色部分</a>
          </li>
        
          <li>
            <a href="/2019/03/25/linux/elementaryos/">elementary OS 使用记录</a>
          </li>
        
          <li>
            <a href="/2019/01/31/tools/git_cmd/">一些常见的 git 命令备忘</a>
          </li>
        
          <li>
            <a href="/2019/01/24/networks/rpc.rpc_poll.rpc_streaming/">图解 rpc rpc_poll 和 rpc_streaming 的差异</a>
          </li>
        
          <li>
            <a href="/2018/11/01/programmer/tools/kconfig-frontends/">kconfig-frontends 简介</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>